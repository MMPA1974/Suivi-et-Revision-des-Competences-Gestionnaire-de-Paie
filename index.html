<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi & Révision des Compétences – Gestionnaire de Paie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Light Theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #EBF2FA; /* Bleu très pâle mais distinct */
            color: #3d4f60; /* Bleu-gris foncé pour le texte général */
        }
        .section-card {
            background-color: #FFFFFF; /* Blanc pur pour les cartes principales */
            border-radius: 0.75rem;
            /* Ombre améliorée pour un effet 3D */
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.18), 0 8px 8px rgba(0, 0, 0, 0.12);
            transition: all 0.3s ease-in-out;
        }
        .week-item.current {
            border-color: #1A3B5A; /* Bleu nuit premium */
            background-color: #E0F2FE; /* Très léger bleu pour la sélection */
            font-weight: 700;
            /* Ombre améliorée pour l'élément actuel */
            box-shadow: 0 10px 20px rgba(0,0,0,0.25), 0 5px 5px rgba(0,0,0,0.15);
            transform: scale(1.03);
        }
        .task-item input:checked + label {
            text-decoration: line-through;
            color: #9CA3AF;
        }
        /* Animation pour la tâche cochée */
        .task-item input:checked + label.animate-check {
            animation: task-complete 0.3s ease-out;
        }
        @keyframes task-complete {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.03); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .calendar-day {
            @apply p-2 text-center rounded-md;
        }
        .calendar-day.today {
            @apply bg-blue-200 font-bold text-blue-800; /* Bleu clair pour aujourd'hui */
        }
        .calendar-day.certif-date {
            @apply bg-red-200 font-bold text-red-800 border-2 border-red-500;
        }
        .calendar-day.other-month {
            @apply text-gray-400;
        }
        /* Couleurs pour la barre de progression et le graphique en thème clair */
        .bg-accent-main { background-color: #1A3B5A; } /* Utilisé pour la barre de progression et les accents principaux */
        .text-accent-main { color: #1A3B5A; }
        .bg-accent-light { background-color: #EBF5FF; } /* Bleu très clair pour les fonds d'accueil */
        .text-accent-dark { color: #15304B; }
        .text-accent-medium { color: #2A527B; } /* Pour des éléments de texte spécifiques */

        /* Couleurs de fond pour les éléments internes des cartes (calendrier, modules) */
        .card-inner-bg {
            background-color: #E0EBF5; /* Un bleu plus distinct pour les fonds internes */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06); /* Ombre interne pour relief */
        }
        .welcome-message-bg { /* Specific background for welcome message */
            background-color: #EBF5FF; /* Light accent blue */
        }

        /* Couleur spécifique pour le texte de progression des blocs d'examen */
        .bloc-progress-text {
            color: #EC4899; /* Pink-500 */
            font-weight: 600;
        }

        /* Style for timeline select dropdown */
        .custom-timeline-select {
            background-color: #FCE7F3; /* Light pink for light theme */
            border-color: #EC4899; /* Pink-500 border */
            color: #EC4899; /* Pink-500 text */
            font-weight: 600;
        }
        .custom-timeline-select option {
            background-color: #FFFFFF; /* White background for options in light theme */
            color: #3d4f60; /* Dark text for options in light theme */
        }


        /* Overrides pour le thème sombre */
        body.dark-theme {
            background-color: #0F172A; /* slate-900 */
            color: #E2E8F0; /* slate-200 */
        }
        body.dark-theme .section-card {
            background-color: #1E293B; /* slate-800 */
            /* Ombres du thème sombre doivent être plus claires pour être visibles sur fond foncé */
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.45), 0 8px 8px rgba(0, 0, 0, 0.25);
        }
        body.dark-theme .week-item.current {
            border-color: #60A5FA; /* blue-400 */
            background-color: #1E3A8A; /* blue-800 */
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), 0 5px 5px rgba(0,0,0,0.3);
        }
        /* Adjusted color for better visibility in dark mode */
        body.dark-theme .task-item label,
        body.dark-theme .course-item label,
        body.dark-theme .ml-7.mt-2.p-2 { /* Also target the suggested courses div */
            color: #94A3B8; /* Tailwind gray-400 - better contrast than pure white on dark backgrounds */
        }
        body.dark-theme .task-item input:checked + label,
        body.dark-theme .course-item input:checked + label {
            color: #6B7280; /* Darker gray for checked items in dark mode */
        }
        /* Fix for quiz modal text color in dark mode */
        body.dark-theme .quiz-modal-content h2,
        body.dark-theme .quiz-modal-content p,
        body.dark-theme .quiz-modal-content label,
        body.dark-theme .quiz-modal-content .text-gray-700,
        body.dark-theme .quiz-modal-content .text-gray-600 {
            color: #E2E8F0; /* slate-200 */
        }
        body.dark-theme .calendar-day.today {
            background-color: #3B82F6; /* blue-500 */
            color: #FFFFFF;
        }
        body.dark-theme .calendar-day.certif-date {
            background-color: #DC2626; /* red-600 */
            color: #FFFFFF;
            border-color: #F87171; /* red-400 */
        }
        body.dark-theme .calendar-day.other-month {
            @apply text-gray-400;
        }
        /* Couleurs spécifiques au thème sombre pour le graphique et la barre de progression */
        body.dark-theme .bg-accent-main { background-color: #60A5FA; } /* blue-400 */
        body.dark-theme .text-accent-main { color: #60A5FA; }
        body.dark-theme .bg-accent-light { background-color: #1D4ED8; } /* blue-700 */
        body.dark-theme .text-accent-dark { color: #BFDBFE; } /* blue-200 */
        body.dark-theme .text-accent-medium { color: #93C5FD; } /* blue-300 */

        /* Couleurs de fond pour les éléments internes des cartes en thème sombre */
        body.dark-theme .card-inner-bg {
            background-color: #334155; /* slate-700 */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); /* Ombre interne pour relief */
        }
        body.dark-theme .welcome-message-bg { /* Specific background for welcome message */
            background-color: #FCE7F3; /* Light pink for dark theme */
        }
        /* Adjust text color for welcome message in dark theme to be readable on light pink */
        body.dark-theme .welcome-message-bg h2,
        body.dark-theme .welcome-message-bg p {
            color: #3d4f60; /* Darker text for readability on light pink */
        }

        /* Couleur spécifique pour le texte de progression des blocs d'examen en thème sombre */
        body.dark-theme .bloc-progress-text {
            color: #F472B6; /* Pink-400 */
            font-weight: 600;
        }


        /* Adaptation des couleurs de texte pour les thèmes */
        .text-gray-800 { color: #1F2937; } /* Tailwind gray-800 */
        .text-gray-700 { color: #374151; } /* Tailwind gray-700 */
        .text-gray-500 { color: #6B7280; } /* Tailwind gray-500 */
        .bg-gray-200 { background-color: #E5E7EB; } /* Tailwind gray-200 for progress bar track */

        body.dark-theme .text-gray-800 { color: #F9FAFB; } /* white */
        body.dark-theme .text-gray-700 { color: #D1D5DB; } /* gray-300 */
        body.dark-theme .bg-gray-200 { background-color: #4B5563; /* slate-600 for progress bar track */
        }

        /* Correction pour la zone de notes personnelles */
        #personal-notes-textarea {
            color: #3d4f60; /* Texte foncé pour le thème clair */
        }
        body.dark-theme #personal-notes-textarea {
            color: #E2E8F0; /* Texte clair pour le thème sombre */
            background-color: #1A202C; /* Fond légèrement plus foncé que le modal pour le contraste */
        }


        /* Chart container styling */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            height: auto;
            margin: auto;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            /* Transition pour l'apparition/disparition des modales */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Empêche les clics quand invisible */
        }
        .modal.is-active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: #fefefe; /* Fond par défaut du thème clair pour la modale */
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            width: 80%;
            max-width: 600px;
            /* Ombre améliorée pour la modale */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 10px 10px rgba(0, 0, 0, 0.15);
            position: relative;
            transform: translateY(-20px); /* Initial position for animation */
            transition: transform 0.3s ease-in-out;
        }
        .modal.is-active .modal-content {
            transform: translateY(0); /* Final position for animation */
        }
        body.dark-theme .modal-content {
            background-color: #1E293B; /* slate-800 pour la modale en thème sombre */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6), 0 10px 10px rgba(0, 0, 0, 0.3);
        }
        body.dark-theme .modal-content h2,
        body.dark-theme .modal-content p,
        body.dark-theme .modal-content ul li {
            color: #E2E8F0; /* Texte clair pour le contenu de la modale en thème sombre */
        }
        body.dark-theme .modal-content .close-button {
            color: #CBD5E1; /* Bouton de fermeture clair */
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Print styles */
        @media print {
            body {
                background-color: #fff;
                color: #000;
            }
            /* Remove no-print class from here as it's now managed by JS for focus mode */
            .header-no-print, .info-cards-no-print, .course-progress-no-print, .chart-no-print, .calendar-no-print, .footer-no-print {
                display: none !important;
            }
            .container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .section-card {
                box-shadow: none !important;
                border: 1px solid #eee;
                margin-bottom: 1rem;
            }
            header, footer {
                text-align: left;
                margin-bottom: 1rem;
            }
            h1, h2, h3, h4 {
                color: #000 !important;
            }
            #details-view {
                padding: 0 !important;
            }
            .modal {
                display: none !important;
            }
        }

        /* Styling for checked course items */
        .course-item input:checked + label {
            text-decoration: line-through;
            color: #9CA3AF; /* Light gray for checked items */
        }
        body.dark-theme .course-item input:checked + label {
            color: #6B7280; /* Darker gray for checked items in dark mode */
        }

        /* Correction for library modal text color in light theme */
        #library-modal .modal-content {
            color: #3d4f60; /* Ensure main text color is dark in light theme */
        }

        #library-modal .modal-content h2,
        #library-modal .modal-content h3,
        #library-modal .modal-content h4,
        #library-modal .modal-content p,
        #library-modal .modal-content ul li {
            color: #3d4f60; /* Apply the dark text color explicitly to all text elements */
        }

        /* Ensure dark theme text color for library modal is also explicit and readable */
        body.dark-theme #library-modal .modal-content h2,
        body.dark-theme #library-modal .modal-content h3,
        body.dark-theme #library-modal .modal-content h4,
        body.dark-theme #library-modal .modal-content p,
        body.dark-theme #library-modal .modal-content ul li {
            color: #E2E8F0; /* slate-200 for dark theme */
        }
        
        /* Correction additionnelle pour les arrière-plans des sections de la bibliothèque en mode sombre */
        body.dark-theme #library-modal .bg-blue-50,
        body.dark-theme #library-modal .bg-green-50,
        body.dark-theme #library-modal .bg-yellow-50,
        body.dark-theme #library-modal .bg-purple-50 {
            background-color: #2D3748; /* Une nuance de gris plus foncée pour mieux contraster avec le texte clair */
        }

        body.dark-theme #library-modal .text-indigo-700,
        body.dark-theme #library-modal .text-teal-700,
        body.dark-theme #library-modal .text-orange-700,
        body.dark-theme #library-modal .text-pink-700,
        body.dark-theme #library-modal .text-pink-600 {
            color: #93C5FD; /* Utilisation d'une couleur d'accentuation plus claire pour les titres des sections en mode sombre */
        }

        /* COULEURS DES BARRES DE PROGRESSION (ROSE VIF) */
        .bg-progress-bright {
            background-color: #FF69B4 !important; /* Rose éclatant */
        }
        body.dark-theme .bg-progress-bright {
            background-color: #FF69B4 !important; /* Rose éclatant même en mode sombre */
        }

        /* Styles pour l'accordéon des cours */
        .accordion-header {
            cursor: pointer;
            padding: 1rem;
            background-color: #F3F4F6; /* gray-100 */
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease-in-out;
            font-weight: 600;
            color: #374151; /* gray-700 */
        }
        body.dark-theme .accordion-header {
            background-color: #334155; /* slate-700 */
            color: #E2E8F0; /* slate-200 */
        }
        .accordion-header:hover {
            background-color: #E5E7EB; /* gray-200 */
        }
        body.dark-theme .accordion-header:hover {
            background-color: #475569; /* slate-600 */
        }
        .accordion-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 0; /* Initialement caché */
        }
        .accordion-content.is-expanded {
            max-height: 1000px; /* Suffisamment grand pour le contenu */
        }
        .accordion-icon {
            transition: transform 0.3s ease-in-out;
        }
        .accordion-icon.rotate {
            transform: rotate(90deg);
        }
        /* New style for action buttons in header */
        .header-action-button {
            @apply flex items-center justify-center w-12 h-12 text-2xl rounded-lg shadow-md transition-all duration-300;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Suivi & Révision des Compétences – Gestionnaire de Paie ✨</h1>
            <p class="text-lg text-gray-500 mt-2">Objectif: Certification Gestionnaire de Paie</p>
            
            <div class="absolute right-0 top-0 flex flex-col items-end gap-2 pr-4 z-10 header-no-print"> <!-- Vertical alignment on right, added z-index and header-no-print -->
                <button id="print-button" class="bg-orange-500 hover:bg-orange-600 text-white font-bold header-action-button">🖨️</button>
                <button id="theme-toggle" class="bg-gray-700 hover:bg-gray-800 text-white font-bold header-action-button">☀️</button>
                <button id="sound-toggle" class="bg-pink-500 hover:bg-pink-600 text-white font-bold header-action-button">🔊</button>
                <button id="focus-mode-toggle" class="bg-green-700 hover:bg-green-800 text-white font-bold header-action-button">🎯</button>
            </div>

            <div id="welcome-message" class="text-center p-8 rounded-lg welcome-message-bg mb-6">
                <!-- Content will be dynamically updated by JS -->
            </div>

            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                <div class="flex items-center gap-2">
                    <label for="first-name" class="text-gray-700 font-medium">Prénom:</label>
                    <input type="text" id="first-name" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto text-blue-900" placeholder="Votre prénom">
                </div>
                <div class="flex items-center gap-2">
                    <label for="last-name" class="text-gray-700 font-medium">Nom:</label>
                    <input type="text" id="last-name" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto text-blue-900" placeholder="Votre nom">
                </div>
            </div>
            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                <div class="flex items-center gap-2">
                    <label for="promo-select" class="text-gray-700 font-medium">Promo:</label>
                    <select id="promo-select" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-blue-900">
                        </select>
                </div>
                <div class="flex items-center gap-2">
                    <label for="session-select" class="text-gray-700 font-medium">Session:</label>
                    <select id="session-select" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-blue-900">
                        </select>
                </div>
            </div>
            <div id="selected-session-info" class="mt-4 text-gray-700">
                </div>
            <div class="mt-2 text-gray-700 text-lg font-semibold">
                <span id="exam-countdown-label"></span>
                <span id="exam-countdown" class="text-accent-main"></span>
            </div>

            <div class="mt-6 flex flex-wrap justify-center gap-4 header-no-print">
                <a href="https://mmpa1974.github.io/Acronyme-Paie-Academy---Guide-Ultime/" target="_blank" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2">
                    Acronymes 🚀
                </a>
                <a href="https://mmpa1974.github.io/Glossaire-de-la-Paie-et-RH-Votre-Compagnon-Expert/" target="_blank" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2">
                    Glossaire 📖
                </a>
                <a href="https://docs.google.com/spreadsheets/d/12Z3vh4jJ9_5kZDF5WkSkTdl_2-WxqDlL8YB7_B9BguI/edit?gid=0#gid=0" target="_blank" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 flex items-center gap-2">
                    Révision 📝
                </a>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 info-cards-no-print" id="info-cards-section">
            <div class="section-card p-6 flex flex-col justify-center items-center">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Jours Restants 🗓️</h2>
                <p id="days-left" class="text-5xl font-bold text-accent-main">95</p>
            </div>
            <div class="section-card p-6">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Progression Totale 🎯</h2>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="progress-bar" class="bg-progress-bright h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p id="progress-text" class="text-center mt-2 text-sm text-gray-600">0% complété</p>
            </div>
            <div class="section-card p-6 flex flex-col justify-center items-center">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Phase Actuelle 💡</h2>
                <p id="current-phase" class="text-xl font-bold text-center text-accent-main">Apprentissage</p>
            </div>
        </div>

        <div class="section-card p-6 mb-8 course-progress-no-print" id="course-progress-main-page">
            <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Progression des Cours 📚</h2>
            <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                <div id="course-progress-bar" class="bg-progress-bright h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p id="course-progress-text" class="text-center mt-2 text-sm text-gray-600">0% complété (0/0 documents)</p>
        </div>

        <div id="course-list-main-section" class="section-card p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Liste des Cours 📚</h2>
            <p class="mb-4 text-gray-700">Voici la liste complète des documents de cours, organisée par blocs et modules. Cochez les documents que vous avez consultés.</p>
            <div id="course-list-content" class="space-y-6">
                </div>
        </div>

        <main class="section-card p-6 md:p-8">
            <div class="flex flex-col space-y-8">
                <div class="w-full flex justify-center chart-no-print" id="chart-section">
                    <div class="chart-container">
                        <canvas id="progress-chart"></canvas>
                    </div>
                </div>

                <div class="w-full space-y-2" id="timeline-section">
                    <h3 class="font-semibold text-lg mb-2 text-gray-700">Navigation Chronologique ⏳</h3>
                    <select id="timeline-select" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-full text-blue-900 custom-timeline-select">
                        </select>
                </div>
                
                <div id="details-view" class="w-full p-4 md:p-6 rounded-lg">
                    <div id="details-content" class="space-y-6"></div>
                    <div id="personal-notes-section" class="mt-8 p-4 rounded-lg shadow-inner card-inner-bg">
                        <h3 class="font-semibold text-lg text-gray-700 mb-2">Mes notes personnelles pour cette période 📝</h3>
                        <textarea id="personal-notes-textarea" class="w-full h-32 p-3 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Écrivez vos pensées, points clés, questions ici..."></textarea>
                    </div>
                </div>

                <div id="calendar-container" class="w-full p-4 rounded-lg shadow-inner card-inner-bg calendar-no-print">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700">‹</button>
                        <h4 id="current-month-year" class="font-semibold text-lg text-gray-800"></h4>
                        <button id="next-month" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700">›</button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-sm">
                        <div class="font-bold text-center text-gray-600">Lun</div>
                        <div class="font-bold text-center text-gray-600">Mar</div>
                        <div class="font-bold text-center text-gray-600">Mer</div>
                        <div class="font-bold text-center text-gray-600">Jeu</div>
                        <div class="font-bold text-center text-gray-600">Ven</div>
                        <div class="font-bold text-center text-gray-600">Sam</div>
                        <div class="font-bold text-center text-gray-600">Dim</div>
                    </div>
                </div>

                <div class="w-full p-4 rounded-lg shadow-inner card-inner-bg footer-no-print text-center">
                    <h3 class="font-semibold text-lg mb-2 text-gray-700">Boost Quotidien ! ✨</h3>
                    <p id="motivational-quote" class="text-sm text-accent-medium italic"></p>
                </div>
            </div>
        </main>

        <footer class="mt-12 text-center text-gray-500 text-sm footer-no-print" id="footer-section">
            <p>Créé par Mathilde Martine PAISLEY L'Enervante 💪🏾</p>
            <div class="flex justify-center items-center gap-4 mt-2 text-sm">
                <a href="https://chat.whatsapp.com/EtV0ux5ipAG5JDhopzo0ut" target="_blank" class="text-blue-600 hover:underline">🔥Payroll Boss Elite Club 👑| Infos & Actus</a>
                <span class="text-gray-400">|</span>
                <a href="https://discord.gg/cBnBkGDFgk" target="_blank" class="text-blue-600 hover:underline">🔥 Payroll Boss Elite Club : Le Hub Paie & Progrès 📈</a>
            </div>
        </footer>
    </div>

    <!-- Modals removed as per user request -->
    <!-- Checklist Modal (Removed) -->
    <!-- Certification Details Modal (Removed) -->
    <!-- Infos Complémentaires Modal (Removed) -->
    <!-- Bibliothèque Modal (Removed) -->

    <div id="quiz-modal" class="modal">
        <div class="modal-content quiz-modal-content">
            <span class="close-button" id="close-quiz-modal">&times;</span>
            <h2 id="quiz-title" class="text-2xl font-bold text-gray-800 mb-4">Quiz du Module</h2>
            <div id="quiz-container" class="space-y-4">
                <p id="quiz-question-number" class="text-gray-600 text-sm"></p>
                <p id="quiz-question-text" class="text-lg font-medium text-gray-700"></p>
                <div id="quiz-options" class="space-y-2">
                    </div>
                <div id="quiz-feedback" class="mt-2 text-center text-sm font-semibold hidden"></div>
                <button id="quiz-submit-button" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">Valider</button>
                <button id="quiz-next-button" class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 hidden">Question Suivante</button>
                <button id="quiz-restart-button" class="mt-4 w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 hidden">Recommencer le Quiz</button>
            </div>
            <div id="quiz-results" class="mt-4 text-center hidden">
                <h3 class="text-xl font-bold text-gray-800">Résultats du Quiz</h3>
                <p id="quiz-score" class="text-2xl font-bold text-accent-main mt-2"></p>
                <p id="quiz-result-message" class="text-gray-700 mt-2"></p>
                <button id="quiz-review-button" class="mt-4 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">Revoir les Réponses</button>
            </div>
        </div>
    </div>


    <script>
        // Raw list of course documents provided by the user (from test10.html)
        const rawCourseListString = `Bloc_1_Gérer la paie et les déclarations sociales
B1_M1_Paramétrer le logiciel de paie
B1_M1_001_Télécharger le logiciel
B1_M1_002_La base de données 2019
B1_M1_003_Lancement de l'application
B1_M1_004_Découverte de l'application
B1_M1_005_La création d'une société
B1_M1_006_Le paramétrage d'une société
B1_M1_007_Le paramétrage de l'établissement
B1_M1_008_La création des fiches salariés
B1_M1_009_Le paramétrage des bulletins modèles
B1_M1_010_Le paramétrage du salaire brut
B1_M1_011_Le paramétrage des cotisations sociales
B1_M1_012_Le paramétrage des salaires nets
B1_M1_013_Les déclarations sociales
B1_M1_014_Questions fréquentes
B1_M1_015_L'Accès à d'autres logiciels de paie
B1_M1_016_Synthèse et application : Paramétrer le logiciel de paie
B1_M2_Collecter et traiter les variables de paie
B1_M2_001_Comment et pourquoi se former à la collecte et au calcul des variables de paie
B1_M2_002_Présentation de la Gestion de la Paie
B1_M2_003_La gestion de la paie (pour débutants)
B1_M2_004_Le temps de travail
B1_M2_005_La rémunération
B1_M2_006_Application : Collecter et traiter les variables de paie
B1_M3_Gérer la rémunération
B1_M3_001_La présentation et la méthodologie du bulletin de salaire
B1_M3_002_Le règlement du salaire
B1_M3_003_La rémunération brute : l'acquisition et la prise de congés payés
B1_M3_004_La rémunération brute : l’indemnité de congés payés
B1_M3_005_La rémunération brute : les heures complémentaires
B1_M3_006_Présentation de la rémunération brute et de la durée légale du travail
B1_M3_007_Présentation de la rémunération brute et le temps de travail effectif
B1_M3_008_La rémunération brute : le salaire de base, les primes et la retenue pour absence
B1_M3_010_La rémunération brute : les heures supplémentaires
B1_M3_011_La rémunération brute : les avantages en nature
B1_M3_012_La rémunération brute : l’arrêt de travail, la retenue pour absence, la subrogation et les IJSS
B1_M3_013_La rémunération brute : l’arrêt de travail et le complément employeur
B1_M3_014_La grève et le lock-out
B1_M4_Traiter les bulletins de salaires
B1_M4_001_Le bulletin de salaire d'un dirigeant sans contrat de travail
B1_M4_002_L'activité partielle
B1_M4_003_Le bulletin de salaire VRP
B1_M4_004_Le bulletin de salaire du BTP (ouvrier)
B1_M4_005_Le bulletin de salaire du BTP (ETAM et Cadres)
B1_M4_006_Le bulletin de salaire Apprenti
B1_M4_007_La gratification stagiaire
B1_M4_008_Synthèse et application : Collecter et traiter les variables de paie
B1_M5_Contrôler et éditer les Bulletins de paie
B1_M5_001_Les diverses cotisations sociales
B1_M5_002_Les bases de calcul des cotisations sociales
B1_M5_003_Les réductions de cotisations sociales
B1_M5_004_Les régularisations de cotisations sociales
B1_M5_005_Le salaire net et le salaire imposable
B1_M5_006_Les impacts du prélèvement à la source
B1_M5_007_Le salaire net à payer et le net social
B1_M5_008_Synthèse et application : Contrôler et éditer les Bulletins de paie
B1_M6_Gérer les déclarations sociales
B1_M6_001_Comment et pourquoi se former à l'édition et au contrôle des déclarations sociales
B1_M6_002_Le livre de paie
B1_M6_003_Les modalités déclaratives
B1_M6_004_Le contenu des déclarations sociales : la réduction générale et TEPA
B1_M6_005_Le contenu des déclarations sociales : les cotisations, le PAS et les contributions sociales
B1_M6_006_La gestion des arrêts de travail en paie
B1_M6_007_La taxe d'apprentissage
B1_M6_008_La gestion de la déclaration d'emploi des travailleurs handicapés
B1_M6_009_Les taxes sur les salaires
B1_M6_010_La participation à la formation continue
B1_M6_011_L'investissement obligatoire dans la construction
B1_M6_012_Synthèse et application : Gérer les déclarations sociales
B1_M7_Analyser les écarts entre la paie et la comptabilité
B1_M7_001_Les enjeux de l'identification et l'analyse des écarts entre la paie et la comptabilité
B1_M7_002_La présentation du plan comptable : généralités
B1_M7_003_Le grand livre comptable et les données paie
B1_M7_004_Les opérations comptables issues de la paie
B1_M7_005_Comptabilisation de la paie
B1_M7_006_L'analyse des causes
B1_M7_007_L'analyse des risques
B1_M7_008_Les opérations de régularisations
B1_M7_009_Synthèse et application : Analyser les écarts entre la paie et la comptabilité
Bloc_2_Assurer la Gestion administrative du personnel
B2_M1_Etablir les contrats de travail
B2_M1_001_La notion de droit du travail
B2_M1_002_La formation du contrat de travail
B2_M1_003_Maîtriser la rédaction d’un contrat de travail
B2_M1_004_L’exécution du contrat de travail
B2_M1_005_Le contrat de travail à durée indéterminée
B2_M1_006_Le CDD et le contrat de travail temporaire
B2_M1_007_Le contrat de travail à temps partiel
B2_M1_008_Les contrats de formation
B2_M1_009_La rédaction du contrat de travail
B2_M1_010_Synthèse et application : Etablir les contrats de travail
B2_M2_Traiter les entrées et sorties des salariés
B2_M2_001_Comment et pourquoi se former à gestion des parcours salariés
B2_M2_002_Le recrutement
B2_M2_003_Les formalités administratives d'embauche
B2_M2_004_La suspension du contrat de travail
B2_M2_005_L'édition des documents de suspension du contrat
B2_M2_006_La rupture du contrat de travail : introduction
B2_M2_007_Le licenciement
B2_M2_008_Les autres modes de rupture du contrat de travail
B2_M2_009_Les fins de contrat : cas du CDD, ICP, Indemnité RTT, ...
B2_M2_010_Les fins de contrat : rupture conventionnelle, départ et mise à la retraite
B2_M2_011_Les formalités de rupture du contrat de travail
B2_M2_012_L'édition des documents de fin de contrat
B2_M2_013_Synthèse et application : Traiter les entrées et sorties des salariés
B2_M3_Gérer les dossiers du personnel
B2_M3_001_La stratégie globale de digitalisation de l'entreprise
B2_M3_002_La transition numérique
B2_M3_003_La digitalisation de la fonction RH
B2_M3_004_La digitalisation des dossiers du personnel
B2_M3_005_Le coffre fort numérique
B2_M3_006_RGPD : Règlement Général de Protection des Données
B2_M3_007_Synthèse et application : Gérer les dossiers du personnel
B2_M4_Communiquer avec les partenaires externes
B2_M4_001_Les partenaires externes du service paie
B2_M4_002_Les outils de communication du service paie avec ses partenaires
B2_M4_003_Les contrôles de l’application du droit du travail
B2_M4_004_Le contentieux de la relation de travail
B2_M4_005_Les procédures de règlement des conflits collectifs
B2_M4_006_Les contrôles et le contentieux social
B2_M4_007_Le rôle et le contrôle de l'URSSAF
B2_M4_008_Synthèse et application : Communiquer avec les partenaires externes
Bloc_3_Conseiller et assister les décideurs et les collaborateurs
B3_M1_Réaliser une veille juridique
B3_M1_001_Le conseil et l'assistance à la direction et aux collaborateurs
B3_M1_002_La démarche de veille
B3_M1_003_La veille juridique
B3_M1_004_Les différents types de veille
B3_M1_005_La notion de droit du travail
B3_M1_006_Les sources professionnelles du droit du travail
B3_M1_007_La hiérarchie des sources du droit du travail
B3_M1_008_La protection sociale, généralités
B3_M1_010_Les pouvoirs de l’employeur et la protection de la santé des salariés
B3_M1_011_Comment effectuer une veille active
B3_M1_012_Le support de communication de la veille juridique
B3_M1_013_Synthèse et application : Réaliser une veille juridique
B3_M2_Diagnostiquer le conformité de la paie
B3_M2_001_L'analyse documentaire
B3_M2_002_La collecte des informations auprès des décideurs
B3_M2_003_L'identification des écarts
B3_M2_004_L'identification des risques encourus
B3_M2_005_Les actions correctrices
B3_M2_006_Le rapport de diagnostic
B3_M2_007_Synthèse et application : Diagnostiquer le conformité de la paie
B3_M3_Communiquer avec les collaborateurs et managers
B3_M3_001_Les fondamentaux de la communication professionnelle
B3_M3_002_L'écoute active
B3_M3_003_La communication non verbale
B3_M3_004_Les fondamentaux de la prise de parole en public
B3_M3_005_Les réunions à distances
B3_M3_006_Rédiger une réponse professionnelle
B3_M3_007_Les fondamentaux de la sécurité sociale
B3_M3_008_L’assurance maladie du régime général
B3_M3_009_L’assurance vieillesse du régime général
B3_M3_010_La protection contre le chômage
B3_M3_011_Synthèse et application : Communiquer avec les collaborateurs et managers
B3_M4_Concevoir des supports de reporting et d’aide à la décision
B3_M4_001_Les fondamentaux d'excel
B3_M4_002_Le calcul des effectifs
B3_M4_003_Le bilan social
B3_M4_004_Le recueil préalable des informations RH
B3_M4_005_L'édition des tableaux de bord sociaux
B3_M4_006_L'analyse et le suivi des tableaux de bord sociaux
B3_M4_007_L'analyse et la prévision de la masse salariale
B3_M4_008_L’association des salariés aux performances de l’entreprise, généralités
B3_M4_009_La participation
B3_M4_010_L'intéressement
B3_M4_011_Les plans d’épargne salariale
B3_M4_012_Synthèse et application : Concevoir des supportsde reporting et d’aide à la décision
B3_M5_Assister les utilisateurs du SIRH
B3_M5_001_L'utilisation d'un SIRH
B3_M5_002_Les enjeux d'un SIRH
B3_M5_003_Les fonctionnalités du SIRH
B3_M5_004_La réglementation inhérente aux SIRH
B3_M5_005_Introduction à la notion de base de données
B3_M5_006_L'exploitation des bases de données
B3_M5_007_L'utilisation du SIRH au quotidien par le collaborateur
B3_M5_008_Proder Talentsoft ou cornerstone
B3_M5_009_La rédaction des courriers à destination du personnel
B3_M5_010_Synthèse et application : Assister les utilisateurs du SIRH`;

        // Initial plan data structure with durations, dates will be calculated dynamically
        const basePlanData = [
            // Phase 1: Apprentissage Intensif (70 jours)
            { id: 's1-2', title: 'Semaines 1-2: Calcul du Bulletin - Bases Approfondies', durationDays: 14, phase: 1, modules: [
                { title: 'Module 1.1: Cotisations Sociales Détaillées 💰', quizId: 'B1_M1_Cotisations_Sociales_Detailees', tasks: [
                    {text: 'Calcul précis des cotisations salariales et patronales (Maladie, Vieillesse, Famille, AT/MP, FNAL, Versement Transport).', suggestedCourses: ['B1_M1_011_Le paramétrage des cotisations sociales', 'B1_M5_001_Les diverses cotisations sociales', 'B1_M5_002_Les bases de calcul des cotisations sociales']},
                    {text: 'Analyse des assiettes spécifiques et des taux dérogatoires (apprentis, contrats aidés, temps partiel).'},
                    {text: 'Maîtrise des réductions et exonérations (Réduction Fillon, CICE résiduel, ZRR).'},
                    {text: 'Impact des dispositifs d\'épargne salariale (PEE, PERCO) sur les cotisations.'},
                    {text: 'Gestion des régularisations de cotisations sur plusieurs périodes.'}
                ]},
                { title: 'Module 1.2: Rémunération et Composantes Avancées 📈', quizId: 'B1_M3_008_La_remuneration_brute', tasks: [ // Renamed quizId for consistency
                    {text: 'Calcul des heures supplémentaires et complémentaires : règles spécifiques, majorations, défiscalisation.', suggestedCourses: ['B1_M3_010_La rémunération brute : les heures supplémentaires']},
                    {text: 'Gestion des primes (anciennété, objectif, 13ème mois) et leur traitement social/fiscal.', suggestedCourses: ['B1_M3_008_La rémunération brute : le salaire de base, les primes et la retenue pour absence']},
                    {text: 'Valorisation et intégration des avantages en nature (logement, véhicule, nourriture) et frais professionnels.', suggestedCourses: ['B1_M3_011_La rémunération brute : les avantages en nature']},
                    {text: 'Calcul des congés payés : méthode du 10ème, maintien de salaire, gestion des compteurs.', suggestedCourses: ['B1_M3_003_La rémunération brute : l\'acquisition et la prise de congés payés', 'B1_M3_004_La rémunération brute : l’indemnité de congés payés']},
                    {text: 'Comprendre les différents types de rémunération variable et leur impact sur le bulletin.'}
                ]}
            ]},
            { id: 's3-4', title: 'Semaines 3-4: Les Absences et Impacts Complexes ⏳', durationDays: 14, phase: 1, modules: [
                { title: 'Module 2.1: Gestion des Absences Maladie/Maternité 🏥', quizId: 'B1_M6_006_La_gestion_des_arrets_de_travail', tasks: [
                    {text: 'Calcul et gestion des indemnités journalières de Sécurité Sociale (IJSS) : conditions, délais de carence.', suggestedCourses: ['B1_M3_012_La rémunération brute : l’arrêt de travail, la subrogation et les IJSS']},
                    {text: 'Mise en œuvre du complément employeur : règles légales, conventionnelles, subrogation.', suggestedCourses: ['B1_M3_013_La rémunération brute : l’arrêt de travail et le complément employeur']},
                    {text: 'Traitement des accidents du travail et maladies professionnelles : déclaration, calcul des indemnités, impact sur le contrat.'},
                    {text: 'Gestion des absences pour maternité, paternité, adoption : droits, durée, calcul des indemnités.'},
                    {text: 'Impact des absences sur les droits à congés payés et RTT.'}
                ]},
                { title: 'Module 2.2: Autres Absences et Situations Spécifiques 📋', quizId: 'B1_M3_014_La_greve_et_le_lock_out', tasks: [
                    {text: 'Gestion des congés spéciaux (événements familiaux, formation, sabbatique) et leur incidence paie.'},
                    {text: 'Traitement des absences injustifiées et des mises à pied conservatoires/disciplinaires.'},
                    {text: 'Comprendre l\'impact des grèves et du chômage partiel sur le bulletin de pa.', suggestedCourses: ['B1_M3_014_La grève et le lock-out']},
                    {text: 'Calcul et gestion des jours de RTT et des compteurs temps.'},
                    {text: 'Analyse des cas complexes d\'absences multiples ou prolongées.'}
                ]}
            ]},
            { id: 's5-6', title: 'Semaines 5-6: Entrées/Sorties et Prélèvement à la Source 💼', durationDays: 14, phase: 1, modules: [
                { title: 'Module 3.1: Gestion des Entrées et Sorties du Personnel 👋', quizId: 'B2_M2_006_La_rupture_du_contrat_de_travail', tasks: [
                    {text: 'Maîtrise du calcul du solde de tout compte (STC) : indemnités de rupture, CP, préavis.'},
                    {text: 'Établissement des documents de fin de contrat (certificat de travail, attestation Pôle Emploi, reçu STC).', suggestedCourses: ['B2_M2_011_Les formalités de rupture du contrat de travail']},
                    {text: 'Gestion des embauches : DPAE, affiliation aux organismes, paramétrage du bulletin.', suggestedCourses: ['B2_M2_003_Les formalités administratives d\'embauche']},
                    {text: 'Comprendre les différents motifs de rupture de contrat (démission, licenciement, rupture conventionnelle) et leurs spécificités paie.', suggestedCourses: ['B2_M2_006_La rupture du contrat de travail : introduction']},
                    {text: 'Traitement des cas de mobilité interne et de transfert de contrat.'}
                ]},
                { title: 'Module 3.2: Prélèvement à la Source (PAS) et Régularisations 💸', quizId: 'B1_M5_006_Les_impacts_du_prelevement_a_la_source', tasks: [
                    {text: 'Calcul du Prélèvement à la Source (PAS) : taux neutre, taux personnalisé, régularisations.', suggestedCourses: ['B1_M5_006_Les impacts du prélèvement à la source']},
                    {text: 'Gestion des changements de taux et des ajustements en cours d\'année.'},
                    {text: 'Comprendre le salaire net imposable et le net social.'},
                    {text: 'Impact du PAS sur les autres éléments du bulletin de paie.'},
                    {text: 'Analyse des cas complexes de régularisation du PAS.'}
                ]}
            ]},
            { id: 's7-8', title: 'Semaines 7-8: Déclaration Sociale Nominative (DSN) Approfondie 💻', durationDays: 14, phase: 1, modules: [
                { title: 'Module 4.1: Structure et Enjeux de la DSN 📑', quizId: 'B1_M6_003_Les_modalites_declaratives', tasks: [
                    {text: 'Analyse approfondie des blocs et rubriques de la DSN : conventions, normes.', suggestedCourses: ['B1_M6_003_Les modalités déclaratives']},
                    {text: 'Comprendre les signalements d\'événements (arrêt de travail, fin de contrat) et leur impact.'},
                    {text: 'Gestion des erreurs et des rejets DSN : correction, dépôt de DSN rectificatives.'},
                    {text: 'Relation entre le logiciel de paie et la DSN : paramétrage, exports.'},
                    {text: 'Veille réglementaire sur les évolutions de la DSN.'}
                ]},
                { title: 'Module 4.2: Taxes et Contributions Spécifiques 📊', quizId: 'B1_M6_007_La_taxe_d_apprentissage', tasks: [
                    {text: 'Calcul et déclaration de la Taxe d\'Apprentissage et de la Contribution Formation Professionnelle (CFP).', suggestedCourses: ['B1_M6_007_La taxe d\'apprentissage']},
                    {text: 'Gestion de la Déclaration Obligatoire d\'Emploi des Travailleurs Handicapés (DOETH).', suggestedCourses: ['B1_M6_008_La gestion de la déclaration d\'emploi des travailleurs handicapés']},
                    {text: 'Comprendre les taxes sur les salaires et leur application.', suggestedCourses: ['B1_M6_009_Les taxes sur les salaires']},
                    {text: 'Analyse des spécificités des taxes et contributions sectorielles.'},
                    {text: 'Optimisation des dispositifs d\'exonération de taxes.'}
                ]}
            ]},
            { id: 's9-10', title: 'Semaines 9-10: Révision Générale et Cas Transversaux 🧠', durationDays: 14, phase: 1, modules: [
                { title: 'Module 5.1: Révision Approfondie et Synthèse 📚', quizId: 'B1_M7_009_Synthese_et_application_Analyser_les_ecarts', tasks: [
                    {text: 'Synthèse des concepts clés de la paie et du droit social.'},
                    {text: 'Création de fiches récapitulatives sur les seuils, les dates et les processus.'},
                    {text: 'Révision des cas particuliers et des exceptions réglementaires.'},
                    {text: 'Mémorisation des articles de loi ou des références importantes.'},
                    {text: 'Organisation de vos connaissances pour une restitution rapide le jour de l\'examen.'}
                ]},
                { title: 'Module 5.2: Cas Pratiques Transversaux et Simulation 💡', quizId: 'B1_M7_009_Synthese_et_application_Analyser_les_ecarts_2', tasks: [
                    {text: 'Résolution de cas pratiques intégrant plusieurs aspects de la paie (embauche, absence, rupture).'},
                    {text: 'Simulation de la gestion d\'un cycle de paie complet sur un mois donné.'},
                    {text: 'Analyse et correction des erreurs courantes dans les bulletins et déclarations.'},
                    {text: 'Préparation à la gestion des questions complexes des collaborateurs.'},
                    {text: 'Développement d\'une approche méthodique pour la résolution de problèmes.'}
                ]}
            ]},
            // Phase 2: Évaluations et Préparation (29 days) - Adjusted durations for 99 total study/prep days
            { id: 's11', title: 'Semaine 11: Évaluations Ciblées et Correction 📝', durationDays: 8, phase: 2, modules: [ // +1 day
                { title: 'Évaluations Modulaires et Ciblage des Lacunes 🔍', quizId: 'S11_Evaluations_Modulaires', tasks: [
                    {text: 'Passer des évaluations ou QCM par module pour mesurer précisément votre niveau.'},
                    {text: 'Analyser en détail les erreurs commises et identifier les lacunes spécifiques.'},
                    {text: 'Réviser intensivement les points faibles identifiés en utilisant des ressources complémentaires.'},
                    {text: 'Créer des exercices personnalisés pour renforcer les domaines de difficulté.'},
                    {text: 'Discuter des points bloquants avec des peers ou des formateurs (si possible).'}
                ]}
            ]},
            { id: 's12', title: 'Semaine 12: Mise en Pratique Intensive 🛠️', durationDays: 8, phase: 2, modules: [ // +1 day
                { title: 'Pratique et Entraînement Chronométré ⏱️', quizId: 'S12_Pratique_Intensive', tasks: [
                    {text: 'Réaliser des cas pratiques complets de paie (de A à Z) en conditions réelles de temps.'},
                    {text: 'Simuler la gestion de situations complexes (ex: régularisations, ruptures conventionnelles).'},
                    {text: 'S\'entraîner à la saisie et au contrôle des données dans un outil de paie simulé (si disponible).'},
                    {text: 'Révisez les aspects procéduraux : déclarations, attestations, documents de fin de contrat.'},
                    {text: 'Développer des réflexes pour identifier rapidement les erreurs courantes.'}
                ]}
            ]},
            { id: 's13', title: 'Semaine 13: Examens Blancs et Stratégie 🎯', durationDays: 8, phase: 2, modules: [ // +1 day
                { title: 'Examens Blancs et Stratégie d\'Examen 🏆', quizId: 'S13_Examens_Blancs', tasks: [
                    {text: 'Réaliser un ou plusieurs examens blancs complets dans les conditions de l\'examen (durée, silence).'},
                    {text: 'Analyser minutieusement vos performances : gestion du temps, compréhension des questions, précision des réponses.'},
                    {text: 'Définir une stratégie pour aborder les différentes parties de l\'examen (QCM, cas pratique, questions ouvertes).'},
                    {text: 'Identifier les pièges courants et les erreurs à éviter.'},
                    {text: 'Travailler sur la rédaction claire et concise des réponses.'}
                ]}
            ]},
            { id: 's14', title: 'Semaine 14: Ultime Préparation et Sérénité ✨', durationDays: 5, phase: 2, modules: [ // +1 day
                { title: 'Derniers Ajustements Avant l\'Examen 🧘‍♀️', quizId: 'S14_Ultime_Preparation', tasks: [
                    {text: 'Revoir les points que you have le plus de mal à retenir (sans apprendre de nouvelles choses).'},
                    {text: 'Faire une dernière simulation rapide de calcul de bulletin.'},
                    {text: 'Vérifier une dernière fois la logistique de l\'examen (trajet, heure).'},
                    {text: 'Se détendre et éviter toute source de stress inutile.'},
                    {text: 'Visualiser votre réussite et rester confiant.'}
                ]}
            ]},
            { id: 'jour-j', title: 'Le Jour J 🎉', durationDays: 2, phase: 2,
                modules: [ // This now represents the actual exam structure
                    { title: 'Bloc 1: Gérer la paie et les déclarations sociales (10h) 📊', tasks: [
                        {text: 'Compétence C1.1: Paramétrer le logiciel de paie (éléments d\'identification, infos collaborateurs, éléments fixes, cotisations et taux).'},
                        {text: 'Compétence C1.2: Collecter et traiter les éléments de rémunération variable (primes, absences, HS, avantages en nature, indemnités de rupture).'},
                        {text: 'Compétence C1.3: Contrôler et éditer les bulletins de paie (spécificités entreprise, montants cotisations, net imposable, net à payer, anomalies).'},
                        {text: 'Compétence C1.4: Réaliser les déclarations sociales nominatives (écarts journal/DSN, cotisations mensuelles/annuelles, anomalies bloquantes).'},
                        {text: 'Compétence C1.5: Identifier et analyser les écarts paie/comptabilité (rapprochement, causes, risques juridiques, actions correctrices).'}
                    ]},
                    { title: 'Bloc 2: Assurer la gestion administrative du personnel (8h) 📋', tasks: [
                        {text: 'Compétence C2.1: Établir les contrats de travail (clauses minimales, obligatoires, spécifiques, conformité Code du Travail/CCN).'},
                        {text: 'Compétence C2.2: Réaliser les formalités embauche/départ (DPAE, RUP, calcul indemnités rupture/CP, documents obligatoires).'},
                        {text: 'Compétence C2.3: Constituer et tenir à jour dossiers personnel (documents essentiels, manquements, RGPD, infos sensibles).'},
                        {text: 'Compétence C2.4: Communiquer avec partenaires externes (Médecine du travail, Inspection du travail, DUERP, dérogations repos dominical).'}
                    ]},
                    { title: 'Bloc 3: Conseiller et assister les décideurs et les collaborateurs (10h) 🤝', tasks: [
                        {text: 'Compétence C3.1: Réaliser une veille juridique (rapport de veille, applicabilité, formalisation/diffusion, méthodologie).'},
                        {text: 'Compétence C3.2: Diagnostiquer la conformité de la paie (minimas conventionnels, avantages en nature, régularisations, risques juridiques).'},
                        {text: 'Compétence C3.3: Communiquer avec collaborateurs/managers (pédagogie, adaptation communication, handicap, références juridiques).'},
                        {text: 'Compétence C3.4: Concevoir supports reporting/aide décision (EMA, turnover, masse salariale, absentéisme, Excel, analyse).'},
                        {text: 'Compétence C3.5: Assister utilisateurs SIRH (mode opératoire, public cible, accessibilité, pédagogie).'}
                    ]}
                ]
            }
        ];

        let planData = []; // This will hold the plan with calculated dates
        // Calculate total study/prep days (excluding 'jour-j' for initial plan calculation)
        const totalStudyAndPrepDays = basePlanData.slice(0, basePlanData.length - 1).reduce((sum, block) => sum + block.durationDays, 0); // Should be 99 now
        
        // Calculate total tasks from basePlanData (moved here to ensure it's defined early)
        let totalTasks; // Declare totalTasks here

        // Checkboxes state ARE now persisted across sessions
        // Using localStorage directly for simplicity as requested, no complex userData object for persistence
        // completedTasks and completedCourses are local Set objects that will be loaded/saved as strings
        let completedTasks = new Set();
        let completedCourses = new Set();
        let personalNotes = {}; // Stores personal notes for each week/module
        // New: Store collapsed state for blocks and modules
        let collapsedBlocks = new Set();
        let collapsedModules = new Set();

        const today = new Date();
        // Define all promo sessions data
        const promoSessions = {
            'DE VINCI': {
                'Session 1': {
                    startDate: '2025-10-27T11:00:00', // ISO format for easy Date object creation
                    endDate: '2025-11-21T23:59:00',
                    newsletter: 'https://app.comptalia.com/v3/blog'
                },
                'Session 2': {
                    startDate: '2026-01-13T11:00:00',
                    endDate: '2026-01-30T23:59:00',
                    newsletter: 'https://app.comptalia.com/v3/blog'
                }
            },
            'PASTEUR': { // Dates fictives ajustées
                'Session 1': {
                    startDate: '2026-04-27T11:00:00', // Début au 27 avril 2026
                    // Ajout de 26 jours à la date de début pour obtenir la date de fin
                    // 27/04/2026 + 26 jours (pour inclure le 27 et le 22) = 22/05/2026.
                    endDate: '2026-05-22T23:59:00',
                    newsletter: 'https://app.comptalia.com/v3/blog',
                    isFictional: true // Marque cette session comme fictive
                },
                'Session 2': {
                    startDate: '2026-06-22T11:00:00', // Début au 22 juin 2026
                    // Ajout de 26 jours à la date de début pour obtenir la date de fin
                    endDate: '2026-07-17T23:59:00',
                    newsletter: 'https://app.comptalia.com/v3/blog',
                    isFictional: true
                }
            },
            'COPERNIC': { // Dates fictives ajustées
                'Session 1': {
                    startDate: '2026-10-26T11:00:00', // Début au lundi 26 octobre 2026
                    // Ajout de 26 jours à la date de début pour obtenir la date de fin
                    endDate: '2026-11-20T23:59:00',
                    newsletter: 'https://app.comptalia.com/v3/blog',
                    isFictional: true // Marque cette session comme fictive
                },
                'Session 2': {
                    startDate: '2026-12-21T11:00:00', // Début au 21 décembre 2026
                    // Ajout de 26 jours à la date de début pour obtenir la date de fin
                    endDate: '2027-01-15T23:59:00',
                    newsletter: 'https://app.comptalia.com/v3/blog',
                    isFictional: true
                }
            }
        };

        let selectedPromoName = localStorage.getItem('selectedPromoName') || Object.keys(promoSessions)[0];
        let selectedSessionKey = localStorage.getItem('selectedSessionKey') || Object.keys(promoSessions[selectedPromoName])[0];
        let selectedSession = promoSessions[selectedPromoName][selectedSessionKey];

        // certifDate now represents the START of the exam period for countdown and calendar highlight
        let certifDate = new Date(selectedSession.startDate);

        let progressChart;
        let currentCalendarDate = new Date(); // State for the calendar's current view
        let clickSynth; // Declare Tone.js synth
        let taskCompleteSynth; // Declare separate synth for task completion sound
        let isSoundEnabled = (localStorage.getItem('isSoundEnabled') === 'false') ? false : true; // Default to true
        let countdownInterval; // To store the interval ID for the exam countdown
        let isFocusMode = false; // État du mode concentration

        // Quiz data for specific modules
        const quizData = {
            'B1_M1_Cotisations_Sociales_Detailees': [
                {
                    question: "Quel est l'objectif principal du paramétrage du logiciel de paie ?",
                    options: ["Définir les salaires des employés", "Assurer la conformité avec la réglementation et la politique de rémunération", "Générer des rapports financiers complexes"],
                    correctAnswer: "Assurer la conformité avec la réglementation et la politique de rémunération"
                },
                {
                    question: "La base de données 2019 est-elle toujours pertinente pour le paramétrage actuel ?",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Faux"
                },
                {
                    question: "Qu'est-ce qu'une cotisation salariale ?",
                    options: ["Une contribution payée par l'employeur", "Une partie du salaire brut retenue pour le financement de la sécurité sociale", "Un impôt sur le revenu"],
                    correctAnswer: "Une partie du salaire brut retenue pour le financement de la sécurité sociale"
                },
                {
                    question: "Le paramétrage d'une société dans le logiciel de paie inclut-il la configuration des caisses de cotisation ?",
                    options: ["Oui", "Non"],
                    correctAnswer: "Oui"
                },
                {
                    question: "Les fiches salariés doivent être créées avant le paramétrage des bulletins modèles.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                },
                {
                    question: "Le paramétrage du salaire brut inclut-il uniquement le salaire de base ?",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Faux"
                },
                {
                    question: "Les déclarations sociales sont-elles paramétrées dans le logiciel de paie ?",
                    options: ["Oui", "Non"],
                    correctAnswer: "Oui"
                }
            ],
            'B1_M3_008_La_remuneration_brute': [
                {
                    question: "Pour un salarié dont la durée hebdomadaire du travail est de 35 heures, le nombre d’heures mensualisées est :",
                    options: ["169 heures", "151,67 heures", "Variable en fonction du nombre d’heures réelles travaillées sur le mois"],
                    correctAnswer: "151,67 heures"
                },
                {
                    question: "Quelle est la formule de calcul permettant de déterminer le taux horaire contractuel d’un salarié ?",
                    options: ["Salaire de base mensuel contractuel divisé par nombre d’heures mensuelles contractuel", "Salaire de base mensuel contractuel multiplié par 12 mois, et divisé nombre d’heures annuelles fixées par la loi (1 607 heures)", "Salaire de base mensuel contractuel divisé par le nombre d’heures devant être travaillées sur le mois"],
                    correctAnswer: "Salaire de base mensuel contractuel divisé par nombre d’heures mensuelles contractuel"
                },
                {
                    question: "La détermination d’un taux horaire est obligatoire pour tous les salariés.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Faux"
                },
                {
                    question: "L’employeur a le droit de verser au salarié une rémunération inférieure au SMIC si :",
                    options: [
                        "La rémunération est conforme au minimum fixé par la convention collective",
                        "Le salarié est en contrat d’apprentissage, contrat de professionnalisation",
                        "Le salarié donne son accord à la signature du contrat de travail",
                        "Un accord collectif le prévoit en fixant une contrepartie",
                        "Le salarié est un VRP exclusif",
                        "Le salarié a moins de 18 ans et il a moins de 6 mois de pratique professionnelle dans la branche de l'emploi",
                        "Aucune disposition ne permet pas de verser une rémunération inférieure au SMIC"
                    ],
                    correctAnswer: "Le salarié est en contrat d’apprentissage, contrat de professionnalisation" // Assuming this is the primary correct answer, as multiple options might be partially true based on the PDF content.
                },
                {
                    question: "L’employeur est dans l’obligation d’appliquer la grille de rémunération fixée par la convention collective, y compris si cette grille pose un salaire minimum inférieur au SMIC.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Faux"
                },
                {
                    question: "À quel moment doit s’effectuer le contrôle du respect du SMIC ?",
                    options: ["À chaque mois de paie", "Sur toute période glissante de 12 mois", "En fin d’année civile", "En début d’année civile"],
                    correctAnswer: "À chaque mois de paie"
                },
                {
                    question: "Parmi les éléments ci-dessous, quels sont ceux qui entrent de plein droit dans la rémunération pour vérifier si le SMIC a bien été versé ?",
                    options: [
                        "La prime d’ancienneté",
                        "Les heures supplémentaires",
                        "Le salaire de base",
                        "Les avantages en nature",
                        "Les primes assises sur les résultats financiers de l’entreprise",
                        "La participation au transport collectif",
                        "Le 13ème mois",
                        "La prime de risque",
                        "La prime sur objectif calculé sur la performance du salarié",
                        "La prime sur objectif calculé sur la performance du salarié",
                        "Tous les éléments de rémunération dès lors qu’ils ont été indiqués dans le contrat de travail"
                    ],
                    correctAnswer: "Le salaire de base" // Again, picking one primary.
                },
                {
                    question: "Si l’horaire de référence dans l’entreprise est inférieur à la durée légale du travail, le contrôle du respect du salaire minimum se fera sur :",
                    options: ["Le SMIC mensuel défini par la loi", "Le SMIC proratisé en fonction de la durée du travail dans l’entreprise", "Le SMIC mensuel défini par la loi"],
                    correctAnswer: "Le SMIC proratisé en fonction de la durée du travail dans l’entreprise"
                },
                {
                    question: "En est-il de même si le salarié a eu des absences non rémunérées ? Sur quelle base doit-on procéder au contrôle du respect du salaire minimum :",
                    options: ["Le SMIC mensuel défini par la loi", "Le SMIC proratisé en fonction de la durée du travail réelle du salarié"],
                    correctAnswer: "Le SMIC proratisé en fonction de la durée du travail réelle du salarié"
                },
                {
                    question: "Comment se traduit la retenue sur salaire liée à une absence non rémunérée sur le bulletin de salaire",
                    options: ["Le salaire de base est réduit pour tenir compte de l’absence", "Le nombre d’heures de la ligne salaire de base garde les valeurs du contrat Une ligne additionnelle négative est ajoutée au niveau du brut du bulletin pour matérialiser l’absence", "Une augmentation des cotisations sociales pour compenser l'absence"],
                    correctAnswer: "Le nombre d’heures de la ligne salaire de base garde les valeurs du contrat Une ligne additionnelle négative est ajoutée au niveau du brut du bulletin pour matérialiser l’absence"
                },
                {
                    question: "Quelles sont les différents types d’absences ?",
                    options: ["Absence rémunérée", "Absence partiellement rémunérée", "Absence non rémunérée"],
                    correctAnswer: "Absence rémunérée" // Assuming all are correct as types of absence
                },
                {
                    question: "Parmi ces absences, quelles sont celles qui imposent à l’employeur un maintien total de la rémunération ?",
                    options: [
                        "Congé sabbatique",
                        "Congé payé",
                        "Evènement familial",
                        "Grève",
                        "Accompagnement du conjoint à un examen médical de suivi de grossesse",
                        "Arrêt maladie",
                        "Retard",
                        "Mise à pied disciplinaire",
                        "Absence injustifiée",
                        "Jour de repos acquis dans le cadre de l’aménagement et de l’organisation du temps de travail"
                    ],
                    correctAnswer: "Congé payé" // Picking one primary.
                },
                {
                    question: "Parmi ces absences, quelles sont celles qui peuvent amener l’employeur à mettre en place un maintien partiel de la rémunération ?",
                    options: [
                        "Congé sabbatique",
                        "Congé payé",
                        "Evènement familial",
                        "Arrêt maladie",
                        "Congé maternité / adoption / paternité",
                        "Journée de formation validée dans le cadre du plan de formation de l’entreprise mais réalisée en dehors du temps de travail"
                    ],
                    correctAnswer: "Arrêt maladie" // Picking one primary.
                },
                {
                    question: "Parmi ces absences, quelles sont celles pour lesquelles l’employeur ne fait pas de maintien de rémunération ?",
                    options: [
                        "Congé sabbatique",
                        "Congé payé",
                        "Grève",
                        "Arrêt maladie",
                        "Journée de formation validée dans le cadre du plan de formation de l’entreprise mais réalisée en dehors du temps de travail",
                        "Mise à pied disciplinaire",
                        "Repos compensateur"
                    ],
                    correctAnswer: "Grève" // Picking one primary.
                },
                {
                    question: "La retenue sur salaire pour absence se calcule de la même façon que la ligne salaire de base, à savoir à partir d’un nombre d’heures moyen ?",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Faux"
                },
                {
                    question: "Il y a de nombreuses méthodes pour calculer la retenue sur salaire pour absence (jour calendaires, jours ouvrables, jours ouvrés, heures réelles, etc.). Tous ces calculs amènent au même résultat :",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Faux"
                },
                {
                    question: "Quelles sont les méthodes de calcul qui vous semblent à privilégier pour calculer la retenue pour absence pour congés payés ?",
                    options: ["Heures réelles", "Jours ouvrables moyen", "Jours ouvrés moyen", "Jours ouvrés réel", "Jours calendaires"],
                    correctAnswer: "Jours ouvrables moyen" // Picking one primary.
                },
                {
                    question: "Quelles sont les méthodes de calcul qui vous semblent à privilégier pour calculer la retenue pour absence sur un motif ne donnant pas lieu à maintien de la rémunération ?",
                    options: ["Heures réelles", "Jours ouvrables moyen", "Jours ouvrés moyen", "Jours ouvrés réel", "Jours calendaires"],
                    correctAnswer: "Heures réelles" // Picking one primary.
                },
                {
                    question: "Quelles sont les méthodes de calcul qui vous semblent à privilégier pour calculer la retenue pour absence sur un motif médical ?",
                    options: ["Heures réelles", "Jours ouvrables moyen", "Jours ouvrés moyen", "Jours ouvrés réel", "Jours calendaires"],
                    correctAnswer: "Jours calendaires" // Picking one primary.
                },
                {
                    question: "La gestion en paie du salaire de base, des primes et des retenues pour absence est complexe car l’entreprise devra faire des choix de calculs. Est-ce exact ?",
                    options: ["Oui", "Non"],
                    correctAnswer: "Oui"
                }
            ],
            'B1_M6_006_La_gestion_des_arrets_de_travail': [
                {
                    question: "La DSN remplace-t-elle toutes les déclarations sociales ?",
                    options: ["Oui, absolument toutes", "Non, certaines déclarations spécifiques subsistent", "Seulement les déclarations mensuelles"],
                    correctAnswer: "Non, certaines déclarations spécifiques subsistent"
                },
                {
                    question: "Un arrêt de travail doit être signalé via la DSN.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                },
                {
                    question: "En cas d'arrêt maladie, l'employeur doit-il toujours maintenir le salaire intégralement ?",
                    options: ["Oui, c'est une obligation légale", "Non, cela dépend de la convention collective et de l'ancienneté du salarié", "Seulement si le salarié est en CDI"],
                    correctAnswer: "Non, cela dépend de la convention collective et de l'ancienneté du salarié"
                }
            ],
            'B1_M3_014_La_greve_et_le_lock_out': [
                {
                    question: "La grève suspend-t-elle le contrat de travail ?",
                    options: ["Oui", "Non"],
                    correctAnswer: "Oui"
                },
                {
                    question: "Un lock-out est une décision unilatérale de l'employeur de fermer l'entreprise.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                },
                {
                    question: "Les jours de grève sont-ils rémunérés par l'employeur ?",
                    options: ["Oui, toujours", "Non, sauf accord contraire", "Seulement si la grève est illégale"],
                    correctAnswer: "Non, sauf accord contraire"
                }
            ],
            'B2_M2_006_La_rupture_du_contrat_de_travail': [
                {
                    question: "La démission est un mode de rupture du contrat de travail à l'initiative de l'employeur.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Faux"
                },
                {
                    question: "Le solde de tout compte doit être remis au salarié à la date de rupture de son contrat de travail.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                },
                {
                    question: "Le certificat de travail est un document obligatoire à remettre au salarié à la fin de son contrat.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                },
                {
                    question: "Quelle formalité doit être effectuée par l'employeur lors de l'embauche d'un salarié ?",
                    options: ["Déclaration Préalable à l'Embauche (DPAE)", "Demande de casier judiciaire", "Envoi d'un CV à Pôle Emploi"],
                    correctAnswer: "Déclaration Préalable à l'Embauche (DPAE)"
                },
                {
                    question: "Le préavis est-il toujours obligatoire en cas de démission ?",
                    options: ["Oui", "Non, sauf dispense par l'employeur", "Non, si le salarié trouve un autre emploi"],
                    correctAnswer: "Non, sauf dispense par l'employeur"
                },
                {
                    question: "La rupture conventionnelle est un mode de rupture du contrat de travail qui nécessite l'accord des deux parties.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                },
                {
                    question: "L'attestation Pôle Emploi est nécessaire pour que le salarié puisse percevoir des allocations chômage.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                }
            ],
            'B1_M5_006_Les_impacts_du_prelevement_a_la_source': [
                {
                    question: "Le prélèvement à la source (PAS) est un impôt collecté par l'employeur pour le compte de l'État.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                },
                {
                    question: "Le taux de PAS est toujours le même pour tous les salariés.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Faux"
                },
                {
                    question: "Les crédits d'impôt sont-ils pris en compte dans le calcul du PAS mensuel ?",
                    options: ["Oui", "Non", "Seulement pour certains crédits"],
                    correctAnswer: "Non" // Generally, credits are handled in the annual tax declaration, not monthly PAS calculation directly.
                }
            ],
            'B1_M6_003_Les_modalites_declaratives': [
                {
                    question: "La DSN est une déclaration mensuelle obligatoire pour la plupart des entreprises.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                },
                {
                    question: "Les signalements d'événements (arrêt maladie, fin de contrat) sont transmis via la DSN.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                },
                {
                    question: "Le livre de paie est un document facultatif.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Faux"
                }
            ],
            'B1_M6_007_La_taxe_d_apprentissage': [
                {
                    question: "La taxe d'apprentissage est un impôt destiné au financement de la formation professionnelle initiale.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                },
                {
                    question: "Les entreprises sont exonérées de la taxe d'apprentissage si elles n'emploient pas d'apprentis.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Faux"
                },
                {
                    question: "La Déclaration d'Obligation d'Emploi des Travailleurs Handicapés (DOETH) est une déclaration annuelle.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                }
            ],
            'B1_M7_009_Synthese_et_application_Analyser_les_ecarts': [
                {
                    question: "L'analyse des écarts entre la paie et la comptabilité est essentielle pour :",
                    options: ["Vérifier la conformité des bulletins de paie", "Identifier les anomalies et les risques financiers", "Optimiser les processus de paie", "Toutes les réponses ci-dessus"],
                    correctAnswer: "Toutes les réponses ci-dessus"
                },
                {
                    question: "Un rapprochement paie-comptabilité permet de s'assurer que les charges de personnel sont correctement imputées.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                }
            ],
            'B1_M7_009_Synthese_et_application_Analyser_les_ecarts_2': [ // Placeholder quizId
                {
                    question: "Les cas pratiques transversaux permettent de :",
                    options: ["Appliquer les connaissances à des situations réelles", "Développer la résolution de problèmes", "Préparer aux questions orales", "Toutes les réponses ci-dessus"],
                    correctAnswer: "Toutes les réponses ci-dessus"
                }
            ],
            'S11_Evaluations_Modulaires': [
                {
                    question: "L'objectif des évaluations modulaires est de mesurer la compréhension individuelle sur des sujets spécifiques.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                }
            ],
            'S12_Pratique_Intensive': [
                {
                    question: "La pratique intensive améliore la rapidité et la précision dans le traitement de la paie.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                }
            ],
            'S13_Examens_Blancs': [
                {
                    question: "Les examens blancs sont utiles pour s'entraîner aux conditions réelles de l'examen.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Vrai"
                }
            ],
            'S14_Ultime_Preparation': [
                {
                    question: "La dernière semaine de préparation doit être consacrée à l'apprentissage de nouvelles notions complexes.",
                    options: ["Vrai", "Faux"],
                    correctAnswer: "Faux"
                }
            ]
        };

        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let correctAnswersCount = 0;
        let selectedAnswer = null;

        // Fonction d'ouverture générique pour les modales
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                // Utilise setTimeout pour ajouter la classe active après un court délai, permettant la transition CSS
                setTimeout(() => modal.classList.add('is-active'), 10); 
                playClickSound();
            }
        }

        // Fonction de fermeture générique pour les modales
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('is-active');
                // Utilise setTimeout pour masquer complètement après la transition CSS
                setTimeout(() => modal.style.display = 'none', 300); 
                playClickSound();
            }
        }

        function populatePromoSelect() {
            const promoSelect = document.getElementById('promo-select');
            if (promoSelect) {
                promoSelect.innerHTML = '';
                for (const promoName in promoSessions) {
                    const option = document.createElement('option');
                    option.value = promoName;
                    option.textContent = promoName;
                    promoSelect.appendChild(option);
                }
            }
        }

        function populateSessionSelect(promo) {
            const sessionSelect = document.getElementById('session-select');
            if (sessionSelect) {
                sessionSelect.innerHTML = '';
                const sessions = promoSessions[promo];
                for (const sessionName in sessions) {
                    const option = document.createElement('option');
                    option.value = sessionName;
                    option.textContent = sessionName;
                    sessionSelect.appendChild(option);
                }
            }
        }

        function calculatePlanDates() {
            planData = JSON.parse(JSON.stringify(basePlanData));

            let studyPlanPrepEndDate = new Date(selectedSession.startDate);
            // La durée totale du plan avant le jour J est calculée ici
            studyPlanPrepEndDate.setDate(studyPlanPrepEndDate.getDate() - 1); // Le jour avant le début de l'examen

            let currentBlockStartDate = new Date(studyPlanPrepEndDate);
            currentBlockStartDate.setDate(currentBlockStartDate.getDate() - (totalStudyAndPrepDays - 1)); // Remonte au début du plan d'étude

            for (let i = 0; i < planData.length - 1; i++) {
                planData[i].startDate = new Date(currentBlockStartDate);
                currentBlockStartDate.setDate(currentBlockStartDate.getDate() + (planData[i].durationDays - 1));
                planData[i].endDate = new Date(currentBlockStartDate);
                currentBlockStartDate.setDate(currentBlockStartDate.getDate() + 1);
            }

            // Ici, nous utilisons les dates de début et de fin définies dans promoSessions directement pour 'jour-j'
            planData[planData.length - 1].startDate = new Date(selectedSession.startDate);
            planData[planData.length - 1].endDate = new Date(selectedSession.endDate);
        }

        function updatePlanDatesAndRender() {
            calculatePlanDates();
            updateDaysLeft();
            renderTimelineNav();
            updateProgress();
            updateSelectedSessionInfo();
            populateSessionSelect(selectedPromoName);
            const sessionSelectElement = document.getElementById('session-select');
            if (sessionSelectElement) {
                sessionSelectElement.value = selectedSessionKey;
            }
            updateWelcomeMessage();
            if (progressChart) {
                progressChart.destroy();
            }
            initChart();
            const currentWeekId = highlightCurrentWeek();
            showDetails(currentWeekId);
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            updateExamCountdown();
        }

        function updateDaysLeft() {
            const daysLeftEl = document.getElementById('days-left');
            const diffTime = certifDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            daysLeftEl.textContent = diffDays > 0 ? diffDays : 0;
        }

        function updateSelectedSessionInfo() {
            const infoDiv = document.getElementById('selected-session-info');
            const sessionStart = new Date(selectedSession.startDate);
            const sessionEnd = new Date(selectedSession.endDate);
            let fictionalNote = selectedSession.isFictional ? '<span class="text-red-500 font-bold ml-2"> (Dates fictives en attente de communication officielle de Studi via la newsletter)</span>' : '';

            infoDiv.innerHTML = `
                <p>Date de l'examen : Du <strong>${formatDateFull(sessionStart)}</strong> au <strong>${formatDateFull(sessionEnd)}</strong>${fictionalNote}</p>
                <p>Newsletter : <a href="${selectedSession.newsletter}" target="_blank" class="text-accent-main hover:underline">Accéder à la Newsletter</a></p>
            `;
        }

        function updateWelcomeMessage() {
            const welcomeMessageDiv = document.getElementById('welcome-message');
            const detailsContentDiv = document.getElementById('details-content');
            
            // Welcome message is always visible now, focus mode only affects timeline
            welcomeMessageDiv.classList.remove('hidden');
            // detailsContentDiv visibility is managed by showDetails()
            
            const firstName = document.getElementById('first-name').value;
            const lastName = document.getElementById('last-name').value;
            
            const promoSelectElement = document.getElementById('promo-select');
            const sessionSelectElement = document.getElementById('session-select');
            const promo = promoSelectElement ? promoSelectElement.value : '';
            const session = sessionSelectElement ? sessionSelectElement.value : '';

            const sessionStart = new Date(selectedSession.startDate);
            const sessionEnd = new Date(selectedSession.endDate);

            let userName = '';
            if (firstName || lastName) {
                userName = `Bonjour <strong>${firstName} ${lastName}</strong> !`;
            } else {
                userName = `Bienvenue`;
            }

            let message = `<h2 class="text-2xl font-bold text-accent-dark">${userName} sur votre espace de révision ! 📚</h2>`;
            message += `<p class="mt-2 text-accent-medium">Ce tableau de bord est conçu pour vous aider à suivre votre montée en compétence bloc par bloc, module par module, et thème par thème, en vue de votre certification <strong>Gestionnaire de Paie</strong> pour la promo <strong>${promo}</strong>, session <strong>${session}</strong>.</p>`;
            message += `<p class="mt-2 text-accent-medium">Votre période d'examen est prévue du <strong>${formatDateFull(sessionStart)}</strong> au <strong>${formatDateFull(sessionEnd)}</strong>.</p>`;
            message += `<p class="mt-2 text-accent-medium">Les révisions se feront toujours de façon stratégique, en commençant par les blocs 1, 2 et 3 en relation avec les compétences attendues. Lors de la phase d'évaluation, vous pourrez suivre vos compétences validées directement ici.</p>`;
            message += `<p class="mt-2 text-accent-medium">Vous y retrouverez des informations essentielles pour le Jour J, les détails de votre certification, des infos complémentaires, ainsi que des onglets dédiés aux acronymes, au glossaire et à votre bibliothèque idéale. Cochez vos tâches pour suivre votre progression et voir votre succès grandir ! 📈 Bonne préparation et que la motivation soit avec vous ! 💪</p>`;
            
            welcomeMessageDiv.innerHTML = message;
        }


        function highlightCurrentWeek() {
            let currentWeekId = '';
            let currentPhaseText = '';
            
            for (let i = 0; i < planData.length; i++) {
                const week = planData[i];
                const start = new Date(week.startDate);
                const end = new Date(week.endDate);
                end.setHours(23, 59, 59, 999);

                if (today >= start && today <= end) {
                    currentWeekId = week.id;
                    currentPhaseText = week.phase === 1 ? 'Apprentissage Intensif' : 'Évaluation & Préparation';
                    break;
                }
            }
            if (!currentWeekId && today > new Date(selectedSession.endDate)) {
                currentWeekId = 'jour-j';
                currentPhaseText = 'Certification Passée !';
            } else if (!currentWeekId && planData.length > 0 && today < planData[0].startDate) {
                currentWeekId = planData[0].id;
                currentPhaseText = 'Pré-apprentissage';
            } else if (!currentWeekId && today >= certifDate && today <= new Date(selectedSession.endDate)) {
                currentWeekId = 'jour-j';
                currentPhaseText = 'Jour(s) d\'examen !';
            } else if (!currentWeekId) {
                // If current date is between last study day and exam start day, or if no plan data exists
                currentWeekId = 'jour-j'; // Default to exam block for pre-exam phase
                currentPhaseText = 'Pré-examen immédiat !';
            }


            const timelineSelect = document.getElementById('timeline-select');
            if (timelineSelect) {
                timelineSelect.value = currentWeekId;
            }
            
            const currentPhaseEl = document.getElementById('current-phase');
            currentPhaseEl.textContent = currentPhaseText;

            return currentWeekId;
        }

        function formatDateShort(date) {
            const options = { day: 'numeric', month: 'short' };
            return date.toLocaleDateString('fr-FR', options);
        }

        function formatDateFull(date) {
            const options = { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('fr-FR', options);
        }

        function renderTimelineNav() {
            const timelineSelect = document.getElementById('timeline-select');
            if (timelineSelect) {
                timelineSelect.innerHTML = '';
                
                planData.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week.id;
                    const formattedStartDate = formatDateShort(week.startDate);
                    const formattedEndDate = formatDateShort(week.endDate);
                    option.textContent = `${week.title} (${formattedStartDate} - ${formattedEndDate})`;
                    timelineSelect.appendChild(option);
                });

                const currentWeekId = highlightCurrentWeek();
                timelineSelect.value = currentWeekId;

                timelineSelect.onchange = (event) => showDetails(event.target.value);
            }
        }

        function showDetails(weekId) {
            document.getElementById('welcome-message').classList.add('hidden');
            const detailsContent = document.getElementById('details-content');
            detailsContent.classList.remove('hidden'); // Ensure details are visible when a week is selected
            const weekData = planData.find(w => w.id === weekId);
            if (!weekData) return;

            const timelineSelect = document.getElementById('timeline-select');
            if (timelineSelect) {
                timelineSelect.value = weekId;
            }

            playClickSound();

            const formattedStartDate = formatDateShort(weekData.startDate);
            const formattedEndDate = formatDateShort(weekData.endDate);

            let html = `<h2 class="text-2xl font-bold text-gray-800 mb-2">${weekData.title}</h2>`;
            html += `<p class="text-gray-500 mb-4">Du ${formattedStartDate} au ${formattedEndDate}</p>`;
            
            if (weekId === 'jour-j') {
                html += `<p class="text-gray-600 mb-4">Pendant cette période d'examen, vous devrez valider les compétences ci-dessous. Cochez-les au fur et à mesure de votre avancement durant l'épreuve. Rappelez-vous que la gestion du temps est clé !</p>`;
                weekData.modules.forEach(bloc => {
                    const blocTasksCount = bloc.tasks.length;
                    const blocCompletedTasks = bloc.tasks.filter(task => completedTasks.has(`${weekId}-${bloc.title.replace(/\s/g, '')}-${bloc.tasks.indexOf(task)}`)).length;
                    const blocPercentage = blocTasksCount > 0 ? Math.round((blocCompletedTasks / blocTasksCount) * 100) : 0;

                    html += `<div class="p-4 border rounded-lg mb-4 card-inner-bg">
                                <h3 class="font-semibold text-lg text-accent-main">${bloc.title}</h3>
                                <div class="w-full bg-gray-300 rounded-full h-2 mt-2">
                                    <div class="bg-progress-bright h-2 rounded-full" style="width: ${blocPercentage}%"></div>
                                </div>
                                <p class="text-sm mt-1 bloc-progress-text">${blocCompletedTasks}/${blocTasksCount} compétences validées (${blocPercentage}%)</p>
                                <ul class="mt-2 space-y-2">`;
                    bloc.tasks.forEach((task, index) => {
                        const taskId = `${weekId}-${bloc.title.replace(/\s/g, '')}-${index}`;
                        const isChecked = completedTasks.has(taskId) ? 'checked' : '';
                        
                        // Ajout de la classe animate-check au label pour l'animation
                        html += `<li class="task-item flex items-center mt-2">
                                    <input type="checkbox" id="${taskId}" class="h-4 w-4 rounded border-gray-300 text-accent-main focus:ring-blue-500" ${isChecked} data-task-id="${taskId}">
                                    <label for="${taskId}" class="ml-3 block text-sm text-gray-700 flex-grow animate-check">${task.text || task}</label>
                                </li>`;
                    });
                    html += `</ul></div>`;
                });
            } else {
                weekData.modules.forEach(module => {
                    html += `<div class="p-4 border rounded-lg mb-4 card-inner-bg">
                                <h3 class="font-semibold text-lg text-accent-main">${module.title}</h3>
                                <ul class="mt-2 space-y-2">`;
                    module.tasks.forEach((task, index) => {
                        const taskId = `${weekId}-${module.title.replace(/\s/g, '')}-${index}`;
                        const isChecked = completedTasks.has(taskId) ? 'checked' : '';
                        
                        // Ajout de la classe animate-check au label pour l'animation
                        html += `<li class="task-item flex items-center">
                                    <input type="checkbox" id="${taskId}" class="h-4 w-4 rounded border-gray-300 text-accent-main focus:ring-blue-500" ${isChecked} data-task-id="${taskId}">
                                    <label for="${taskId}" class="ml-3 block text-sm text-gray-700 flex-grow animate-check">${task.text || task}</label>
                                </li>`;
                        
                        if (task.suggestedCourses && Array.isArray(task.suggestedCourses) && task.suggestedCourses.length > 0) {
                            html += `<div class="ml-7 mt-2 p-2 bg-gray-100 rounded-md text-gray-700 text-xs">
                                                <p class="font-semibold mb-1">Cours suggérés :</p>
                                                <ul class="list-none space-y-1">`;
                            task.suggestedCourses.forEach(courseId => {
                                const courseData = getCourseDataById(courseId);
                                if (courseData) {
                                    const courseIsChecked = completedCourses.has(courseId) ? 'checked' : '';
                                    html += `<li class="course-item flex items-center">
                                                        <input type="checkbox" id="suggested-course-${courseId}" class="h-3 w-3 rounded border-gray-300 text-purple-500 focus:ring-purple-500" ${courseIsChecked} data-course-id="${courseId}">
                                                        <label for="course-${courseId}" class="ml-2 block text-xs flex-grow">${courseData.code}: ${courseData.title}</label>
                                                    </li>`;
                                }
                            });
                            html += `</ul></div>`;
                        }
                    });
                    html += `</ul>`;
                    // Add Quiz button for modules that have quiz data
                    if (module.quizId && quizData[module.quizId]) {
                        html += `<button class="mt-4 bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300" onclick="openQuiz('${module.quizId}', '${module.title}')">Démarrer le Quiz</button>`;
                    } else {
                        html += `<button class="mt-4 bg-gray-400 text-white font-bold py-2 px-4 rounded-lg shadow-md cursor-not-allowed" disabled>Quiz non disponible</button>`;
                    }
                    html += `</div>`;
                });
            }
            detailsContent.innerHTML = html;

            // Load and save personal notes for the current period
            const notesTextarea = document.getElementById('personal-notes-textarea');
            const notesKey = `notes-${weekId}`;
            notesTextarea.value = personalNotes[notesKey] || '';
            notesTextarea.oninput = () => {
                personalNotes[notesKey] = notesTextarea.value;
                saveUserData(); // Save notes automatically on input
            };
        }

        // Modifié pour utiliser data-attribut et délégation
        function toggleTask(taskId) {
            const checkbox = document.getElementById(taskId);
            const label = checkbox.nextElementSibling;

            if (completedTasks.has(taskId)) {
                completedTasks.delete(taskId);
                label.classList.remove('animate-check');
            } else {
                completedTasks.add(taskId);
                label.classList.add('animate-check');
            }
            saveUserData();

            console.log('toggleTask - completedTasks after toggle and save:', Array.from(completedTasks));

            playTaskToggleSound();
            updateProgress();
            // Le re-render de showDetails() va recharger les états des cases
            const currentWeekId = document.getElementById('timeline-select').value;
            if (currentWeekId) {
                showDetails(currentWeekId); 
            }
        }

        function updateProgress() {
            const percentage = totalTasks > 0 ? Math.round((completedTasks.size / totalTasks) * 100) : 0;
            
            const progressBar = document.getElementById('progress-bar');
            // Ensure the main progress bar uses the bright pink
            progressBar.classList.remove('bg-accent-main'); 
            progressBar.classList.add('bg-progress-bright'); // Use the new bright class
            progressBar.style.width = `${percentage}%`;
            
            const progressText = document.getElementById('progress-text');
            let progressMessage = '';
            if (percentage === 100) {
                progressMessage = '🎉 Bravo ! Toutes les tâches sont complétées !';
            } else if (percentage > 75) {
                progressMessage = 'Presque au but ! Continuez votre excellent travail ! 🚀';
            } else if (percentage > 50) {
                progressMessage = 'Belle avancée ! La moitié du chemin est faite ! 💪';
            } else if (percentage > 25) {
                progressMessage = 'En bonne voie ! Gardez le rythme ! 👍';
            } else {
                progressMessage = 'Commencez fort ! Chaque pas compte ! 🌟';
            }
            progressText.textContent = `${percentage}% complété (${completedTasks.size}/${totalTasks} tâches) ${progressMessage}`;
            
            if (progressChart) {
                const isDark = document.body.classList.contains('dark-theme');
                // Update chart colors to match the bright pink
                progressChart.data.datasets[0].backgroundColor = ['#FF69B4', isDark ? '#475569' : '#E5E7EB'];
                progressChart.data.datasets[0].data = [completedTasks.size, totalTasks - completedTasks.size];
                progressChart.update();
            }
        }
        
        function initChart() {
            const ctx = document.getElementById('progress-chart').getContext('2d');
            const isDark = document.body.classList.contains('dark-theme');
            
            progressChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Tâches Complétées', 'Tâches Restantes'],
                    datasets: [{
                        data: [completedTasks.size, totalTasks - completedTasks.size],
                        // Use the bright pink for the chart too
                        backgroundColor: ['#FF69B4', isDark ? '#475569' : '#E5E7EB'],
                        borderColor: ['#FFFFFF'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                color: getComputedStyle(document.body).getPropertyValue('color')
                            }
                        },
                        tooltip: {
                            enabled: true
                        }
                    }
                }
            });
        }

        function renderCalendar(year, month) {
            const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
            document.getElementById('current-month-year').textContent = `${monthNames[month]} ${year}`;

            const calendarGrid = document.getElementById('calendar-grid');
            while (calendarGrid.children.length > 7) {
                calendarGrid.removeChild(calendarGrid.lastChild);
            }

            const firstDayOfMonth = new Date(year, month, 1);
            const startingDay = (firstDayOfMonth.getDay() + 6) % 7; // Adjust to make Monday the first day
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < startingDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendarGrid.appendChild(emptyDay);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDay = new Date(year, month, day);
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'calendar-day';

                if (currentDay.toDateString() === today.toDateString()) {
                    dayEl.classList.add('today');
                }
                // Highlight the entire exam period
                const examStart = new Date(selectedSession.startDate);
                const examEnd = new Date(selectedSession.endDate);
                examEnd.setHours(23, 59, 59, 999); // Ensure end of day

                if (currentDay >= examStart && currentDay <= examEnd) {
                    dayEl.classList.add('certif-date');
                }
                
                calendarGrid.appendChild(dayEl);
            }
        }

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        }

        function initSound() {
            // Un petit son pour les clics
            clickSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.001,
                    decay: 0.05,
                    sustain: 0.01,
                    release: 0.1
                }
            }).toDestination();
            // Un son distinct pour la validation de tâche
            taskCompleteSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle" },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0.05,
                    release: 0.2
                }
            }).toDestination();

            // S'assurer que Tone.js démarre avec la première interaction utilisateur
            document.documentElement.addEventListener('mousedown', Tone.start);
            document.documentElement.addEventListener('touchstart', Tone.start);
        }

        function playClickSound() {
            if (isSoundEnabled && clickSynth) {
                clickSynth.triggerAttackRelease("C5", "8n");
            }
        }
        function playTaskToggleSound() {
            if (isSoundEnabled && taskCompleteSynth) {
                taskCompleteSynth.triggerAttackRelease("G4", "16n");
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-toggle').textContent = isDark ? '🌙' : '☀️'; // Update emoji
            if (progressChart) {
                progressChart.destroy();
                initChart();
                updateProgress();
            }
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            playClickSound(); // Jouer le son au changement de thème
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('theme-toggle').textContent = '🌙'; // Set emoji
            } else {
                document.body.classList.remove('dark-theme');
                document.getElementById('theme-toggle').textContent = '☀️'; // Set emoji
            }
        }

        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            localStorage.setItem('isSoundEnabled', isSoundEnabled);
            updateSoundButton();
            if (isSoundEnabled) {
                Tone.start(); // S'assurer que le contexte audio est démarré si ce n'était pas le cas
                playClickSound(); // Jouer un son pour confirmer l'activation
            }
        }

        function updateSoundButton() {
            const soundButton = document.getElementById('sound-toggle');
            soundButton.textContent = isSoundEnabled ? '🔊' : '🔇'; // Update emoji
        }

        function updateExamCountdown() {
            const now = new Date();
            const examStart = new Date(selectedSession.startDate);
            const examEnd = new Date(selectedSession.endDate);
            examEnd.setHours(23, 59, 59, 999); // Ensure end of day

            const countdownEl = document.getElementById('exam-countdown');
            const countdownLabelEl = document.getElementById('exam-countdown-label');

            let diffMs;
            let labelText = '';

            if (now < examStart) {
                diffMs = examStart - now;
                labelText = 'Examen dans : ';
            } else if (now >= examStart && now <= examEnd) {
                diffMs = examEnd - now;
                labelText = 'Examen en cours : Reste ';
            } else {
                countdownLabelEl.textContent = 'Examen terminé ! 🎉';
                countdownEl.textContent = '';
                clearInterval(countdownInterval); // Stop the interval
                return;
            }

            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);

            countdownLabelEl.textContent = labelText;
            countdownEl.textContent = `${days}j ${hours}h ${minutes}m ${seconds}s`;
        }

        function displayMotivationalQuote() {
            const quoteEl = document.getElementById('motivational-quote');
            if (quoteEl) {
                const randomIndex = Math.floor(Math.random() * motivationalQuotes.length);
                quoteEl.textContent = motivationalQuotes[randomIndex];
            }
        }

        function parseHierarchicalCourseList(rawString) {
            const hierarchicalList = {};
            let currentBlockKey = null;
            let currentModuleKey = null;

            rawString.split('\n').forEach(line => {
                line = line.trim();
                if (!line) return;

                if (line.startsWith('Bloc_')) {
                    currentBlockKey = line;
                    hierarchicalList[currentBlockKey] = {};
                    currentModuleKey = null;
                } else if (line.match(/^B\d+_M\d+_\d{3}_/)) { // This regex was correct for documents
                    if (currentBlockKey && currentModuleKey && hierarchicalList[currentBlockKey]) {
                        if (!hierarchicalList[currentBlockKey][currentModuleKey]) {
                            hierarchicalList[currentBlockKey][currentModuleKey] = [];
                        }
                        hierarchicalList[currentBlockKey][currentModuleKey].push(line);
                    }
                } else if (line.match(/^B\d+_M\d+_/)) { // This regex was correct for modules
                    currentModuleKey = line;
                    if (currentBlockKey && hierarchicalList[currentBlockKey]) {
                        hierarchicalList[currentBlockKey][currentModuleKey] = [];
                    }
                }
            });
            return hierarchicalList;
        }

        const allCourseDocuments = parseHierarchicalCourseList(rawCourseListString);

        function getCourseDataById(courseId) {
            for (const blockTitleKey in allCourseDocuments) {
                const modulesInBlock = allCourseDocuments[blockTitleKey];
                for (const moduleTitleKey in modulesInBlock) {
                    const documentsInModule = modulesInBlock[moduleTitleKey];
                    for (const docEntry of documentsInModule) {
                        if (docEntry === courseId) {
                            const lastUnderscoreIndex = docEntry.lastIndexOf('_');
                            let code = docEntry;
                            let title = docEntry;
                            if (lastUnderscoreIndex !== -1) {
                                code = docEntry.substring(0, lastUnderscoreIndex);
                                title = docEntry.substring(lastUnderscoreIndex + 1).replace(/_/g, ' ');
                            }
                            return { code, title };
                        }
                    }
                }
            }
            return null;
        }

        // Helper to get progress for a given block or module
        function getProgressForContainer(containerKey, type = 'block') {
            let total = 0;
            let completed = 0;

            if (type === 'block') {
                const modulesInBlock = allCourseDocuments[containerKey];
                if (modulesInBlock) {
                    for (const moduleKey in modulesInBlock) {
                        const documentsInModule = modulesInBlock[moduleKey];
                        total += documentsInModule.length;
                        documentsInModule.forEach(docEntry => {
                            if (completedCourses.has(docEntry)) {
                                completed++;
                            }
                        });
                    }
                }
            } else if (type === 'module') {
                // Find the block first
                let documentsInModule = [];
                for (const blockKey in allCourseDocuments) {
                    if (allCourseDocuments[blockKey][containerKey]) {
                        documentsInModule = allCourseDocuments[blockKey][containerKey];
                        break;
                    }
                }
                total = documentsInModule.length;
                documentsInModule.forEach(docEntry => {
                    if (completedCourses.has(docEntry)) {
                        completed++;
                    }
                });
            }
            return { total, completed, percentage: total > 0 ? Math.round((completed / total) * 100) : 0 };
        }


        function renderCourseListContent() {
            const courseListContentDiv = document.getElementById('course-list-content');
            if (!courseListContentDiv) {
                console.error("Element with ID 'course-list-content' not found.");
                return;
            }
            courseListContentDiv.innerHTML = '<p class="text-center text-gray-500">Génération de la liste des cours...</p>';

            const hierarchicalCourses = allCourseDocuments;
            let html = '';

            for (const blockTitleKey in hierarchicalCourses) {
                const blockDisplayTitle = blockTitleKey.replace(/_/g, ' ');
                const blockId = `block-${blockTitleKey.replace(/[^a-zA-Z0-9]/g, '-')}`; // Sanitize for ID
                const isBlockCollapsed = collapsedBlocks.has(blockId);
                const blockProgress = getProgressForContainer(blockTitleKey, 'block');
                const blockProgressText = `${blockProgress.completed}/${blockProgress.total} documents (${blockProgress.percentage}%)`;

                html += `
                    <div class="p-4 border rounded-lg mb-6 card-inner-bg">
                        <div id="${blockId}" class="accordion-header" onclick="toggleBlock('${blockId}')">
                            <h3 class="font-bold text-xl text-accent-dark">${blockDisplayTitle}</h3>
                            <div class="flex items-center">
                                <span class="text-sm text-gray-600 mr-2">${blockProgressText}</span>
                                <div class="w-24 bg-gray-300 rounded-full h-2">
                                    <div class="bg-progress-bright h-2 rounded-full" style="width: ${blockProgress.percentage}%"></div>
                                </div>
                                <span class="accordion-icon ml-2 ${isBlockCollapsed ? '' : 'rotate'}">▶</span>
                            </div>
                        </div>
                        <div id="${blockId}-content" class="accordion-content ${isBlockCollapsed ? '' : 'is-expanded'}">
                            <div class="ml-4 mt-4 space-y-4">`; // Added ml-4 mt-4 for spacing

                const modulesInBlock = hierarchicalCourses[blockTitleKey];
                for (const moduleTitleKey in modulesInBlock) {
                    const moduleDisplayTitle = moduleTitleKey.replace(/_/g, ' ');
                    const moduleId = `module-${moduleTitleKey.replace(/[^a-zA-Z0-9]/g, '-')}`; // Sanitize for ID
                    const isModuleCollapsed = collapsedModules.has(moduleId);
                    const moduleProgress = getProgressForContainer(moduleTitleKey, 'module');
                    const moduleProgressText = `${moduleProgress.completed}/${moduleProgress.total} documents (${moduleProgress.percentage}%)`;

                    html += `
                                <div class="p-3 border rounded-lg card-inner-bg">
                                    <div id="${moduleId}" class="accordion-header" onclick="toggleModule('${moduleId}')">
                                        <h4 class="font-semibold text-lg text-accent-main">${moduleDisplayTitle}</h4>
                                        <div class="flex items-center">
                                            <span class="text-sm text-gray-600 mr-2">${moduleProgressText}</span>
                                            <div class="w-20 bg-gray-300 rounded-full h-2">
                                                <div class="bg-progress-bright h-2 rounded-full" style="width: ${moduleProgress.percentage}%"></div>
                                            </div>
                                            <span class="accordion-icon ml-2 ${isModuleCollapsed ? '' : 'rotate'}">▶</span>
                                        </div>
                                    </div>
                                    <div id="${moduleId}-content" class="accordion-content ${isModuleCollapsed ? '' : 'is-expanded'}">
                                        <ul class="list-none space-y-1 text-gray-700 mt-2">`; // Added mt-2 for spacing

                    const documentsInModule = modulesInBlock[moduleTitleKey];
                    if (documentsInModule.length > 0) {
                        documentsInModule.forEach(docEntry => {
                            const lastUnderscoreIndex = docEntry.lastIndexOf('_');
                            let code = docEntry;
                            let title = docEntry;
                            if (lastUnderscoreIndex !== -1) {
                                code = docEntry.substring(0, lastUnderscoreIndex);
                                title = docEntry.substring(lastUnderscoreIndex + 1).replace(/_/g, ' ');
                            }
                            const courseId = docEntry;
                            const isChecked = completedCourses.has(courseId) ? 'checked' : '';
                            
                            // Suppression de onchange, ajout de data-course-id
                            html += `<li class="course-item flex items-center mt-2">
                                                <input type="checkbox" id="course-${courseId}" class="h-4 w-4 rounded border-gray-300 text-accent-main focus:ring-blue-500" ${isChecked} data-course-id="${courseId}">
                                                <label for="course-${courseId}" class="ml-3 block text-sm flex-grow">${code}: ${title}</label>
                                            </li>`;
                        });
                    } else {
                        html += `<p class="text-gray-500 italic">Aucun document détaillé pour ce module.</p>`;
                    }
                    html += `        </ul>
                                    </div>
                                </div>`;
                }
                html += `    </div>
                        </div>
                    </div>`;
            }
            courseListContentDiv.innerHTML = html;

            // Adjust max-height for expanded content after rendering
            document.querySelectorAll('.accordion-content.is-expanded').forEach(contentDiv => {
                contentDiv.style.maxHeight = contentDiv.scrollHeight + 'px';
            });
        }

        function toggleBlock(blockId) {
            const contentDiv = document.getElementById(`${blockId}-content`);
            const icon = document.querySelector(`#${blockId} .accordion-icon`); // Find icon within the block header

            if (collapsedBlocks.has(blockId)) {
                collapsedBlocks.delete(blockId);
                contentDiv.classList.add('is-expanded');
                contentDiv.style.maxHeight = contentDiv.scrollHeight + 'px'; // Set to scrollHeight for smooth transition
                icon.classList.add('rotate');
            } else {
                collapsedBlocks.add(blockId);
                contentDiv.classList.remove('is-expanded');
                contentDiv.style.maxHeight = '0';
                icon.classList.remove('rotate');
            }
            saveUserData();
            playClickSound();
        }

        function toggleModule(moduleId) {
            const contentDiv = document.getElementById(`${moduleId}-content`);
            const icon = document.querySelector(`#${moduleId} .accordion-icon`); // Find icon within the module header

            if (collapsedModules.has(moduleId)) {
                collapsedModules.delete(moduleId);
                contentDiv.classList.add('is-expanded');
                contentDiv.style.maxHeight = contentDiv.scrollHeight + 'px'; // Set to scrollHeight for smooth transition
                icon.classList.add('rotate');
            } else {
                collapsedModules.add(moduleId);
                contentDiv.classList.remove('is-expanded');
                contentDiv.style.maxHeight = '0';
                icon.classList.remove('rotate');
            }
            saveUserData();
            playClickSound();
        }

        // Renommé et adapté pour la délégation
        function handleCheckboxChange(event) {
            const checkbox = event.target;
            let idToToggle = null;
            let isTaskCheckbox = false;

            if (checkbox.matches('[data-task-id]')) { // Pour les tâches des semaines
                idToToggle = checkbox.dataset.taskId;
                isTaskCheckbox = true;
            } else if (checkbox.matches('[data-course-id]')) { // Pour les documents de cours (liste principale ou suggérés)
                idToToggle = checkbox.dataset.courseId;
                isTaskCheckbox = false;
            }

            if (idToToggle) {
                if (isTaskCheckbox) {
                    if (completedTasks.has(idToToggle)) {
                        completedTasks.delete(idToToggle);
                    } else {
                        completedTasks.add(idToToggle);
                    }
                    saveUserData();
                    console.log('Task Checkbox Change - completedTasks:', Array.from(completedTasks));
                    playTaskToggleSound();
                    updateProgress();
                    const currentWeekId = document.getElementById('timeline-select').value;
                    if (currentWeekId) {
                        showDetails(currentWeekId); 
                    }
                } else { // It's a course item
                    if (completedCourses.has(idToToggle)) {
                        completedCourses.delete(idToToggle);
                    } else {
                        completedCourses.add(idToToggle);
                    }
                    saveUserData();
                    console.log('Course Checkbox Change - completedCourses:', Array.from(completedCourses));
                    playTaskToggleSound();
                    updateCourseProgress();
                    renderCourseListContent(); // Re-render to update block/module progress bars
                }
            }
        }


        function updateCourseProgress() {
            let totalCoursesCount = 0;
            for (const blockTitleKey in allCourseDocuments) {
                const modulesInBlock = allCourseDocuments[blockTitleKey];
                for (const moduleTitleKey in modulesInBlock) {
                    totalCoursesCount += modulesInBlock[moduleTitleKey].length;
                }
            }

            const completedCoursesCount = completedCourses.size;
            const percentage = totalCoursesCount > 0 ? Math.round((completedCoursesCount / totalCoursesCount) * 100) : 0;

            const progressBar = document.getElementById('course-progress-bar');
            const progressText = document.getElementById('course-progress-text');

            if (progressBar && progressText) {
                // Ensure the course progress bar also uses the bright pink
                progressBar.classList.remove('bg-purple-500'); // Remove old class if exists
                progressBar.classList.add('bg-progress-bright'); // Use the new bright class
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `${percentage}% complété (${completedCoursesCount}/${totalCoursesCount} documents)`;
            }
        }

        // --- Quiz Functions ---
        function openQuiz(moduleId, moduleTitle) {
            currentQuizQuestions = quizData[moduleId];
            if (!currentQuizQuestions || currentQuizQuestions.length === 0) {
                // Using a custom modal for alerts instead of window.alert
                showCustomAlert("Désolé, aucun quiz n'est disponible pour ce module pour le moment.");
                return;
            }
            document.getElementById('quiz-title').textContent = `Quiz : ${moduleTitle}`;
            openModal('quiz-modal'); // Utilisation de la fonction générique d'ouverture
            resetQuiz();
        }

        function resetQuiz() {
            currentQuestionIndex = 0;
            correctAnswersCount = 0;
            document.getElementById('quiz-container').classList.remove('hidden');
            document.getElementById('quiz-results').classList.add('hidden');
            document.getElementById('quiz-submit-button').classList.remove('hidden');
            document.getElementById('quiz-next-button').classList.add('hidden');
            document.getElementById('quiz-feedback').classList.add('hidden');
            document.getElementById('quiz-restart-button').classList.add('hidden');
            document.getElementById('quiz-review-button').classList.add('hidden');
            showQuestion();
        }

        function showQuestion() {
            playClickSound();
            const questionData = currentQuizQuestions[currentQuestionIndex];
            document.getElementById('quiz-question-number').textContent = `Question ${currentQuestionIndex + 1} / ${currentQuizQuestions.length}`;
            document.getElementById('quiz-question-text').textContent = questionData.question;
            
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            questionData.options.forEach((option, index) => {
                const optionId = `quiz-option-${index}`;
                const optionHtml = `
                    <div class="flex items-center">
                        <input type="radio" id="${optionId}" name="quiz-option" value="${option}" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                        <label for="${optionId}" class="ml-3 block text-base font-medium text-gray-700">${option}</label>
                    </div>
                `;
                optionsContainer.insertAdjacentHTML('beforeend', optionHtml);
            });

            document.getElementById('quiz-submit-button').classList.remove('hidden');
            document.getElementById('quiz-next-button').classList.add('hidden');
            document.getElementById('quiz-feedback').classList.add('hidden');
            selectedAnswer = null;
        }

        function submitQuizAnswer() {
            const selectedOption = document.querySelector('input[name="quiz-option"]:checked');
            const feedbackElement = document.getElementById('quiz-feedback');
            
            if (!selectedOption) {
                feedbackElement.textContent = "Veuillez sélectionner une réponse.";
                feedbackElement.classList.remove('hidden');
                feedbackElement.classList.remove('text-green-600', 'text-red-600');
                feedbackElement.classList.add('text-yellow-600');
                return;
            }

            selectedAnswer = selectedOption.value;
            const questionData = currentQuizQuestions[currentQuestionIndex];

            if (selectedAnswer === questionData.correctAnswer) {
                correctAnswersCount++;
                feedbackElement.textContent = "Correct ! 🎉";
                feedbackElement.classList.remove('text-red-600', 'text-yellow-600');
                feedbackElement.classList.add('text-green-600');
            } else {
                feedbackElement.textContent = `Incorrect. La bonne réponse était : "${questionData.correctAnswer}"`;
                feedbackElement.classList.remove('text-green-600', 'text-yellow-600');
                feedbackElement.classList.add('text-red-600');
            }
            feedbackElement.classList.remove('hidden');

            document.getElementById('quiz-submit-button').classList.add('hidden');
            if (currentQuestionIndex < currentQuizQuestions.length - 1) {
                document.getElementById('quiz-next-button').classList.remove('hidden');
            } else {
                showQuizResults();
            }
            
            // Disable options after submission
            document.querySelectorAll('input[name="quiz-option"]').forEach(radio => radio.disabled = true);
        }

        function showNextQuestion() {
            currentQuestionIndex++;
            showQuestion();
        }

        function showQuizResults() {
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');
            document.getElementById('quiz-score').textContent = `${correctAnswersCount} / ${currentQuizQuestions.length}`;
            
            let message = "";
            const percentage = (correctAnswersCount / currentQuizQuestions.length) * 100;
            if (percentage === 100) {
                message = "Félicitations ! Vous avez un score parfait ! 🏆";
            } else if (percentage >= 75) {
                message = "Excellent travail ! Vous maîtrisez bien le sujet. 👍";
            } else if (percentage >= 50) {
                message = "Bon début ! Continuez à réviser pour améliorer votre score.📚";
            } else {
                message = "Ne vous inquiétez pas, la pratique rend parfait. Revoyez le module ! 💡";
            }
            document.getElementById('quiz-result-message').textContent = message;
            document.getElementById('quiz-restart-button').classList.remove('hidden');
            document.getElementById('quiz-review-button').classList.remove('hidden');
        }

        function reviewQuizAnswers() {
            // This function could be expanded to show all questions with correct/incorrect highlights.
            // For now, it just resets the quiz.
            resetQuiz();
        }

        // Custom Alert/Confirmation Modals (replacing window.alert/confirm)
        function showCustomAlert(message) {
            const alertModal = document.createElement('div');
            alertModal.id = 'custom-alert-modal';
            alertModal.className = 'modal is-active'; // Directly active
            alertModal.innerHTML = `
                <div class="modal-content max-w-sm">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Notification</h2>
                    <p class="text-gray-700 mb-6">${message}</p>
                    <button id="custom-alert-ok" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">OK</button>
                </div>
            `;
            document.body.appendChild(alertModal);

            document.getElementById('custom-alert-ok').addEventListener('click', () => {
                alertModal.classList.remove('is-active');
                setTimeout(() => alertModal.remove(), 300);
            });
        }


        // --- Fonctions de sauvegarde et chargement des données utilisateur ---
        function saveUserData() {
            const userData = {
                firstName: document.getElementById('first-name').value,
                lastName: document.getElementById('last-name').value,
                selectedPromoName: selectedPromoName,
                selectedSessionKey: selectedSessionKey,
                completedTasks: Array.from(completedTasks),
                completedCourses: Array.from(completedCourses),
                personalNotes: personalNotes, // Sauvegarde les notes personnelles
                collapsedBlocks: Array.from(collapsedBlocks), // Save collapsed blocks state
                collapsedModules: Array.from(collapsedModules) // Save collapsed modules state
            };
            localStorage.setItem('userData', JSON.stringify(userData));
        }

        function loadUserData() {
            const savedData = localStorage.getItem('userData');
            if (savedData) {
                const userData = JSON.parse(savedData);
                document.getElementById('first-name').value = userData.firstName || '';
                document.getElementById('last-name').value = userData.lastName || '';
                selectedPromoName = userData.selectedPromoName || Object.keys(promoSessions)[0];
                selectedSessionKey = userData.selectedSessionKey || Object.keys(promoSessions[selectedPromoName])[0];
                selectedSession = promoSessions[selectedPromoName][selectedSessionKey];
                completedTasks = new Set(userData.completedTasks || []);
                completedCourses = new Set(userData.completedCourses || []);
                personalNotes = userData.personalNotes || {}; // Charge les notes personnelles
                collapsedBlocks = new Set(userData.collapsedBlocks || []); // Load collapsed blocks state
                collapsedModules = new Set(userData.collapsedModules || []); // Load collapsed modules state
            }
        }

        // Citations motivantes
        const motivationalQuotes = [
            "Le succès n'est pas final, l'échec n'est pas fatal : c'est le courage de continuer qui compte. – Winston Churchill",
            "La seule façon de faire du bon travail est d'aimer ce que vous faites. – Steve Jobs",
            "Croyez en vous-même, et tout ce que vous êtes est possible. – Mary Kay Ash",
            "La vie, c'est comme une bicyclette, il faut avancer pour ne pas perdre l'équilibre. – Albert Einstein",
            "La meilleure façon de prédire l'avenir est de le créer. – Peter Drucker",
            "Chaque accomplissement commence par la décision d'essayer. – John F. Kennedy",
            "Peu importe la lenteur de votre progression, du moment que vous ne vous arrêtez pas. – Confucius",
            "Faites de chaque jour votre chef-d'œuvre. – John Wooden",
            "Le succès n'est pas la clé du bonheur. Le bonheur est la clé du succès. Si vous aimez ce que vous faites, vous réussirez. – Albert Schweitzer",
            "La persévérance est la clé du succès. – Inconnu"
        ];

        // Fonction pour basculer le mode concentration
        function toggleFocusMode() {
            isFocusMode = !isFocusMode;
            const timelineSection = document.getElementById('timeline-section');

            if (timelineSection) {
                if (isFocusMode) {
                    timelineSection.classList.add('hidden');
                } else {
                    timelineSection.classList.remove('hidden');
                }
            }

            // Gérer le texte du bouton
            document.getElementById('focus-mode-toggle').textContent = isFocusMode ? '🌐' : '🎯'; // Update emoji
            playClickSound();
        }

        // --- Initialisation au chargement de la page ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme(); // Charger le thème avant tout
            initSound(); // Initialiser le synthétiseur Tone.js
            updateSoundButton(); // Mettre à jour le texte du bouton son

            populatePromoSelect();
            loadUserData(); // Charger les données utilisateur (y compris promo et session sélectionnées, notes, et états d'accordéon)
            updatePlanDatesAndRender(); // Recalculer les dates et rendre la vue

            document.getElementById('promo-select').value = selectedPromoName;
            document.getElementById('session-select').value = selectedSessionKey;
            
            // Écouteurs pour les changements de sélection promo/session
            document.getElementById('promo-select')?.addEventListener('change', (event) => {
                selectedPromoName = event.target.value;
                selectedSessionKey = Object.keys(promoSessions[selectedPromoName])[0]; // Réinitialise la session à la première de la nouvelle promo
                selectedSession = promoSessions[selectedPromoName][selectedSessionKey];
                localStorage.setItem('selectedPromoName', selectedPromoName);
                localStorage.setItem('selectedSessionKey', selectedSessionKey);
                certifDate = new Date(selectedSession.startDate); // Mettre à jour certifDate
                updatePlanDatesAndRender();
                showDetails(highlightCurrentWeek()); // Afficher les détails de la semaine en cours après mise à jour
            });

            document.getElementById('session-select')?.addEventListener('change', (event) => {
                selectedSessionKey = event.target.value;
                selectedSession = promoSessions[selectedPromoName][selectedSessionKey];
                localStorage.setItem('selectedSessionKey', selectedSessionKey);
                certifDate = new Date(selectedSession.startDate); // Mettre à jour certifDate
                updatePlanDatesAndRender();
                showDetails(highlightCurrentWeek()); // Afficher les détails de la semaine en cours après mise à jour
            });

            // Écouteurs pour les champs Prénom/Nom pour la sauvegarde automatique
            document.getElementById('first-name')?.addEventListener('input', saveUserData);
            document.getElementById('last-name')?.addEventListener('input', saveUserData);

            // Boutons de navigation du calendrier
            document.getElementById('prev-month')?.addEventListener('click', () => {
                changeMonth(-1);
                playClickSound();
            });
            document.getElementById('next-month')?.addEventListener('click', () => {
                changeMonth(1);
                playClickSound();
            });

            // Écouteurs des boutons principaux
            document.getElementById('print-button')?.addEventListener('click', () => {
                window.print();
                playClickSound();
            });

            document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
            document.getElementById('sound-toggle')?.addEventListener('click', toggleSound);
            document.getElementById('focus-mode-toggle')?.addEventListener('click', toggleFocusMode);


            // --- ÉCOUTEURS POUR LES MODALES ---
            // Les écouteurs pour les modales supprimées ont été retirés ici.

            // --- Fonctions du quiz ---
            document.getElementById('quiz-submit-button')?.addEventListener('click', submitQuizAnswer);
            document.getElementById('quiz-next-button')?.addEventListener('click', showNextQuestion);
            document.getElementById('quiz-restart-button')?.addEventListener('click', resetQuiz);
            document.getElementById('quiz-review-button')?.addEventListener('click', reviewQuizAnswers);

            const quizModal = document.getElementById('quiz-modal');
            const closeQuizModalBtn = document.getElementById('close-quiz-modal');
            if (closeQuizModalBtn && quizModal) {
                closeQuizModalBtn.addEventListener('click', () => closeModal('quiz-modal'));
            }

            // Ajout de la délégation d'événements pour toutes les checkboxes
            document.body.addEventListener('change', handleCheckboxChange);

            // Initialiser le compteur de tâches total
            totalTasks = planData.reduce((sum, week) => {
                return sum + week.modules.reduce((modSum, module) => modSum + module.tasks.length, 0);
            }, 0);

            // Mise à jour initiale de la progression
            updateProgress();
            updateCourseProgress();
            displayMotivationalQuote(); // Afficher une citation motivante au chargement
            countdownInterval = setInterval(updateExamCountdown, 1000); // Mettre à jour le compte à rebours toutes les secondes

            // Rendre la liste des cours directement au chargement de la page
            renderCourseListContent();
        });
    </script>
</body>
</html>
